(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{117:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return l}));var a=n(2),i=n(6),o=(n(0),n(150)),r={id:"sidecar_configmap",title:"Sidecar ConfigMap",sidebar_label:"Sidecar ConfigMap"},s={id:"user_guides/sidecar_configmap",title:"Sidecar ConfigMap",description:"This document guides you to define a specified sidecar ConfigMap for your application.",source:"@site/docs/user_guides/sidecar_configmap.md",permalink:"/docs/user_guides/sidecar_configmap",editUrl:"https://github.com/pingcap/chaos-mesh/edit/master/website/docs/user_guides/sidecar_configmap.md",sidebar_label:"Sidecar ConfigMap",sidebar:"docs",previous:{title:"KernelChaos Experiment",permalink:"/docs/user_guides/kernelchaos_experiment"},next:{title:"Sidecar Template",permalink:"/docs/user_guides/sidecar_template"}},c=[{value:"Why do we need a specified Sidecar ConfigMap?",id:"why-do-we-need-a-specified-sidecar-configmap",children:[]},{value:"How it works?",id:"how-it-works",children:[]},{value:"Injection Configuration",id:"injection-configuration",children:[{value:"Containers",id:"containers",children:[]},{value:"Tips",id:"tips",children:[]}]},{value:"Usage",id:"usage",children:[]}],p={rightToc:c};function l(e){var t=e.components,n=Object(i.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"This document guides you to define a specified sidecar ConfigMap for your application."),Object(o.b)("h2",{id:"why-do-we-need-a-specified-sidecar-configmap"},"Why do we need a specified Sidecar ConfigMap?"),Object(o.b)("p",null,"Chaos Mesh runs a ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.kernel.org/doc/Documentation/filesystems/fuse.txt"}),"fuse-daemon")," server in ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.magalix.com/blog/the-sidecar-pattern"}),"sidecar container")," for implementing file system IOCChaos."),Object(o.b)("p",null,"In sidecar container, fuse-daemon needs to mount the data directory of application by ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"http://manpages.ubuntu.com/manpages/bionic/en/man1/fusermount.1.html"}),"fusermount")," before the application starts."),Object(o.b)("h2",{id:"how-it-works"},"How it works?"),Object(o.b)("p",null,"Currently, Chaos Mesh supports two types of ConfigMaps:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Template config. The skeleton of each sidecar config is similar, in order to fulfill different requirements and make the configuration simplified,\nChaos Mesh supports creating common templates to be used by different applications. For the details of template configuration, please refer to ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"sidecar_template"}),"template config"),".")),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Injection config. This configuration will be combined with template config and finally generate a config to inject to the selected pods.\nSince most applications use different data directories, volume name or container name, you can define different parameters based on the common template created in the first step."))),Object(o.b)("h2",{id:"injection-configuration"},"Injection Configuration"),Object(o.b)("p",null,"The following content is an injection ConfigMap defined for tikv:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: chaosfs-tikv\n  namespace: chaos-testing\n  labels:\n    app.kubernetes.io/component: webhook\ndata:\n  chaosfs-tikv: |\n    name: chaosfs-tikv\n    selector:\n      labelSelectors:\n        "app.kubernetes.io/component": "tikv"\n    template: chaosfs-sidecar\n    arguments:\n      ContainerName: "tikv"\n      DataPath: "/var/lib/tikv/data"\n      MountPath: "/var/lib/tikv"\n      VolumeName: "tikv"\n')),Object(o.b)("p",null,"Injection config defines some injection arguments for different applications, and it is based on the common template created beforehand."),Object(o.b)("p",null,"For fields defined in this config, we have some brief descriptions below:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"name"),": injection config name, uniquely identifies a injection config in one namespace.\nHowever, you can have the same name in different namespaces so this is useful to implement multi-tenancy."),Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"selector"),": is used to filter pods to inject sidecar."),Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"template"),": the template config map name used to render the injection config."),Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"arguments"),": the arguments you should define to be used in the template.")),Object(o.b)("p",null,"The final injection config content is rendered by ",Object(o.b)("inlineCode",{parentName:"p"},"template")," and ",Object(o.b)("inlineCode",{parentName:"p"},"arguments")," via ",Object(o.b)("inlineCode",{parentName:"p"},"Go Template")," and\nwill be injected to the selected pods. In this example, the final injection config is:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{}),'    name: chaosfs-tikv\n    selector:\n      labelSelectors:\n        "app.kubernetes.io/component": "tikv"    \n    initContainers:\n    - name: inject-scripts\n      image: pingcap/chaos-scripts:latest\n      imagePullPolicy: Always\n      command: ["sh", "-c", "/scripts/init.sh -d /var/lib/tikv/data -f /var/lib/tikv/fuse-data"]\n    containers:\n    - name: chaosfs\n      image: pingcap/chaos-fs:latest\n      imagePullPolicy: Always\n      ports:\n      - containerPort: 65534\n      securityContext:\n        privileged: true\n      command:\n        - /usr/local/bin/chaosfs\n        - -addr=:65534\n        - -pidfile=/tmp/fuse/pid\n        - -original=/var/lib/tikv/fuse-data\n        - -mountpoint=/var/lib/tikv/data\n      volumeMounts:\n        - name: tikv\n          mountPath: /var/lib/tikv\n          mountPropagation: Bidirectional\n    volumeMounts:\n    - name: tikv\n      mountPath: /var/lib/tikv\n      mountPropagation: HostToContainer\n    - name: scripts\n      mountPath: /tmp/scripts\n    - name: fuse\n      mountPath: /tmp/fuse\n    volumes:\n    - name: scripts\n      emptyDir: {}\n    - name: fuse\n      emptyDir: {}\n    postStart:\n      tikv:\n        command:\n          - /tmp/scripts/wait-fuse.sh\n')),Object(o.b)("p",null,"For more sample ConfigMap files, see ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"../examples/chaosfs-configmap"}),"examples"),"."),Object(o.b)("h3",{id:"containers"},"Containers"),Object(o.b)("h4",{id:"chaosfs"},Object(o.b)("inlineCode",{parentName:"h4"},"chaosfs")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"chaosfs")," container is designed as a sidecar container and ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/pingcap/chaos-mesh/tree/master/cmd/chaosfs"}),"chaosfs")," process runs in this container."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"chaosfs")," uses ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/hanwen/go-fuse"}),"fuse libary")," and ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.kernel.org/doc/Documentation/filesystems/fuse.txt"}),"fusermount")," tool to implement a fuse-daemon service and mounts the application's data directory. ",Object(o.b)("inlineCode",{parentName:"p"},"chaosfs")," hijacks all the file system IO actions of the application, so it can be used to simulate various real-world IO faults."),Object(o.b)("p",null,"The following configuration injects ",Object(o.b)("inlineCode",{parentName:"p"},"chaosfs")," container to the target pods and starts a ",Object(o.b)("inlineCode",{parentName:"p"},"chaosfs")," process in this container."),Object(o.b)("p",null,"In addition, ",Object(o.b)("inlineCode",{parentName:"p"},"chaosfs")," container should be run as ",Object(o.b)("inlineCode",{parentName:"p"},"privileged")," and the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/storage/volumes/#mount-propagation"}),Object(o.b)("inlineCode",{parentName:"a"},"mountPropagation"))," field in ",Object(o.b)("inlineCode",{parentName:"p"},"chaosfs")," Container.volumeMounts should be set to ",Object(o.b)("inlineCode",{parentName:"p"},"Bidirectional"),"."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"chaosfs")," uses ",Object(o.b)("inlineCode",{parentName:"p"},"fusermount")," to mount the data directory of the application container in ",Object(o.b)("inlineCode",{parentName:"p"},"chaosfs")," container."),Object(o.b)("p",null,"If any Pod with ",Object(o.b)("inlineCode",{parentName:"p"},"Bidirectional")," mount propagation to the same volume mounts anything there, the Container with ",Object(o.b)("inlineCode",{parentName:"p"},"HostToContainer")," mount propagation will see it."),Object(o.b)("p",null,"This mode is equal to ",Object(o.b)("inlineCode",{parentName:"p"},"rslave")," mount propagation as described in the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.kernel.org/doc/Documentation/filesystems/sharedsubtree.txt"}),"Linux kernel documentation"),"."),Object(o.b)("p",null,"More detail about ",Object(o.b)("inlineCode",{parentName:"p"},"Mount propagation")," can be found ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/storage/volumes/#mount-propagation"}),"here"),"."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),"containers:\n- name: chaosfs\n  image: pingcap/chaos-fs\n  imagePullpolicy: Always\n  ports:\n  - containerPort: 65534\n  securityContext:\n    privileged: true\n  command:\n    - /usr/local/bin/chaosfs\n    - -addr=:65534\n    - -pidfile=/tmp/fuse/pid\n    - -original=/var/lib/tikv/fuse-data\n    - -mountpoint=/var/lib/tikv/data\n  volumeMounts:\n    - name: tikv\n      mountPath: /var/lib/tikv\n      mountPropagation: Bidirectional\n")),Object(o.b)("p",null,"Description of ",Object(o.b)("inlineCode",{parentName:"p"},"chaosfs"),":"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"addr"),': defines the address of the grpc server, default value: ":65534".'),Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"pidfile"),": defines the pid file to record the pid of the ",Object(o.b)("inlineCode",{parentName:"li"},"chaosfs")," process."),Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"original"),": defines the fuse directory. This directory is usually set to the same level directory as the application data directory."),Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"mountpoint"),": defines the mountpoint to mount the original directory.")),Object(o.b)("p",null,"This value should be set to the data directory of the target application."),Object(o.b)("h4",{id:"chaos-scripts"},Object(o.b)("inlineCode",{parentName:"h4"},"chaos-scripts")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"chaos-scripts")," container is used to inject some scripts to the target pods including ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/pingcap/chaos-mesh/blob/master/hack/wait-fuse.sh"}),"wait-fuse.sh"),"."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"wait-fuse.sh")," is used by application container to ensure that the fuse-daemon server is running normally before the application starts."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"chaos-scripts")," is generally used as an initContainer to do some preparations."),Object(o.b)("p",null,"The following config uses ",Object(o.b)("inlineCode",{parentName:"p"},"chaos-scripts")," container to inject scripts and moves the scripts to ",Object(o.b)("inlineCode",{parentName:"p"},"/tmp/scripts")," directory using ",Object(o.b)("inlineCode",{parentName:"p"},"init.sh"),". ",Object(o.b)("inlineCode",{parentName:"p"},"/tmp/scripts")," is an ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/storage/volumes/#emptydir"}),"emptyDir volume")," used to share the scripts with all containers of the pod."),Object(o.b)("p",null,"So you can use ",Object(o.b)("inlineCode",{parentName:"p"},"wait-fuse.sh")," script in tikv container to ensure that the fuse-daemon server is running normally before the application starts."),Object(o.b)("p",null,"In addition, ",Object(o.b)("inlineCode",{parentName:"p"},"init.sh")," creates a directory named ",Object(o.b)("inlineCode",{parentName:"p"},"fuse-data")," in the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/storage/persistent-volumes/"}),"PersistentVolumes")," directory of the tikv as the original directory for fuse-daemon server and the original directory is required."),Object(o.b)("p",null,"You should also create the original directory in the PersistentVolumes directory of the application."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'initContainers:\n  - name: inject-scripts\n    image: pingcap/chaos-scripts:latest\n    imagePullpolicy: Always\n    command: ["sh", "-c", "/scripts/init.sh -d /var/lib/tikv/data -f /var/lib/tikv/fuse-data"]\n')),Object(o.b)("p",null,"The usage of ",Object(o.b)("inlineCode",{parentName:"p"},"init.sh"),":"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"$ ./scripts/init.sh -h\nUSAGE: ./scripts/init.sh [-d data directory] [-f fuse directory]\nUsed to do some preparation\nOPTIONS:\n   -h                      Show this message\n   -d <data directory>     Data directory of the application\n   -f <fuse directory>     Data directory of the fuse original directory\n   -s <scripts directory>  Scripts directory\nEXAMPLES:\n   init.sh -d /var/lib/tikv/data -f /var/lib/tikv/fuse-data\n")),Object(o.b)("h3",{id:"tips"},"Tips"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"The application Container.volumeMounts used to define data directory should be set to ",Object(o.b)("inlineCode",{parentName:"li"},"HostToContainer"),"."),Object(o.b)("li",{parentName:"ol"},Object(o.b)("inlineCode",{parentName:"li"},"scripts")," and ",Object(o.b)("inlineCode",{parentName:"li"},"fuse")," emptyDir should be created and should be mounted to all container of the pod."),Object(o.b)("li",{parentName:"ol"},"The application uses ",Object(o.b)("inlineCode",{parentName:"li"},"wait-fuse.sh")," script to ensure that the fuse-daemon server is running normally.")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),"postStart:\n  tikv:\n    command:\n      - /tmp/scripts/wait-fuse.sh\n")),Object(o.b)("p",null,"The usage of ",Object(o.b)("inlineCode",{parentName:"p"},"wait-fuse.sh"),":"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"$ ./scripts/wait-fuse.sh -h\n./scripts/wait-fuse.sh: option requires an argument -- h\nUSAGE: ./scripts/wait-fuse.sh [-a <host>] [-p <port>]\nWaiting for fuse server ready\nOPTIONS:\n   -h                   Show this message\n   -f <host>            Set the target file\n   -d <delay>           Set the delay time\n   -r <retry>           Set the retry count\nEXAMPLES:\n   wait-fuse.sh -f /tmp/fuse/pid -d 5 -r 60\n")),Object(o.b)("h2",{id:"usage"},"Usage"),Object(o.b)("p",null,"See ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"iochaos_experiment"}),"IOChaos Document"),"."))}l.isMDXComponent=!0},150:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return m}));var a=n(0),i=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=i.a.createContext({}),l=function(e){var t=i.a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},b=function(e){var t=l(e.components);return i.a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},u=i.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,r=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),b=l(n),u=a,m=b["".concat(r,".").concat(u)]||b[u]||d[u]||o;return n?i.a.createElement(m,s(s({ref:t},p),{},{components:n})):i.a.createElement(m,s({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=u;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var p=2;p<o;p++)r[p]=n[p];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);