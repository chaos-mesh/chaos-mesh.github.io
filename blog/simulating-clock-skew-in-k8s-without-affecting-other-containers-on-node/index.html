<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.69">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-90760217-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Chaos MeshÂ®" href="/opensearch.xml"><title data-react-helmet="true">Simulating Clock Skew in K8s Without Affecting Other Containers on the Node | Chaos MeshÂ®</title><meta data-react-helmet="true" property="og:title" content="Simulating Clock Skew in K8s Without Affecting Other Containers on the Node | Chaos MeshÂ®"><meta data-react-helmet="true" name="description" content="Clock synchronization in distributed system"><meta data-react-helmet="true" property="og:description" content="Clock synchronization in distributed system"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:image" content="https://chaos-mesh.org/img/clock-sync-chaos-engineering-k8s.jpg"><meta data-react-helmet="true" property="twitter:image" content="https://chaos-mesh.org/img/clock-sync-chaos-engineering-k8s.jpg"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Simulating Clock Skew in K8s Without Affecting Other Containers on the Node"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/styles.d47af59d.css">
<link rel="preload" href="/styles.3f26a57a.js" as="script">
<link rel="preload" href="/runtime~main.a8ac29bc.js" as="script">
<link rel="preload" href="/main.7cc3356b.js" as="script">
<link rel="preload" href="/1.59f8c63f.js" as="script">
<link rel="preload" href="/2.f64c1922.js" as="script">
<link rel="preload" href="/ccc49370.5c7c61e4.js" as="script">
<link rel="preload" href="/e3f34e86.93b6458b.js" as="script">
<link rel="preload" href="/6897adcd.4060e1b5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top navbarHideable_3046 navbarHidden_1Uo_"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logos/logo-mini.svg" alt="Chaos Mesh Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/logos/logo-mini-white.svg" alt="Chaos Mesh Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Chaos MeshÂ®</strong></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/docs/">1.1.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/">Next</a></li><li><a class="dropdown__link" href="/docs/">1.1.0</a></li><li><a class="dropdown__link" href="/docs/1.0.3/">1.0.3</a></li><li><a class="dropdown__link" href="/docs/0.9.1/">0.9.1</a></li></ul></div><a class="navbar__item navbar__link" href="/docs">Documentation</a><a class="navbar__item navbar__link" href="/interactiveTutorial">Interactive Tutorial</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">âŒ˜</span><span class="DocSearch-Button-Key">K</span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logos/logo-mini.svg" alt="Chaos Mesh Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/logos/logo-mini-white.svg" alt="Chaos Mesh Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Chaos MeshÂ®</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/">Next</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/">1.1.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/1.0.3/">1.0.3</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/0.9.1/">0.9.1</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs">Documentation</a></li><li class="menu__list-item"><a class="menu__link" href="/interactiveTutorial">Interactive Tutorial</a></li><li class="menu__list-item"><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_3I7I thin-scrollbar"><h3 class="sidebarItemTitle_2Dv3">Recent posts</h3><ul class="sidebarItemList_1RlG"><li class="sidebarItem_Hxgp"><a class="sidebarItemLink_3ppv" href="/blog/how-a-top-game-company-uses-chaos-engineering-to-improve-testing">How a Top Game Company Uses Chaos Engineering to Improve Testing</a></li><li class="sidebarItem_Hxgp"><a class="sidebarItemLink_3ppv" href="/blog/chaos-engineering-breaking-things-intentionally">Chaos Engineering - Breaking things Intentionally</a></li><li class="sidebarItem_Hxgp"><a class="sidebarItemLink_3ppv" href="/blog/chaos-mesh-x-hacktoberfest-2020">Chaos Mesh X Hacktoberfest 2020 - An Invitation to Open Source</a></li><li class="sidebarItem_Hxgp"><a class="sidebarItemLink_3ppv" href="/blog/chaos-mesh-1.0-chaos-engineering-on-kubernetes-made-easier">Chaos Mesh 1.0: Chaos Engineering on Kubernetes Made Easier</a></li><li class="sidebarItem_Hxgp"><a class="sidebarItemLink_3ppv" href="/blog/chaos-mesh-action-integrate-chaos-engineering-into-your-ci">chaos-mesh-action: Integrate Chaos Engineering into Your CI</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">Simulating Clock Skew in K8s Without Affecting Other Containers on the Node</h1><div class="margin-vert--md"><time datetime="2020-04-20T00:00:00.000Z" class="blogPostDate_3bQP">April 20, 2020  Â· 9 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/cwen0" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/22956341?v=4" alt="Cwen Yin"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/cwen0" target="_blank" rel="noreferrer noopener">Cwen Yin</a></h4><small class="avatar__subtitle">Maintainer of Chaos Mesh</small></div></div></header><section class="markdown"><p><img alt="Clock synchronization in distributed system" src="/assets/images/clock-sync-chaos-engineering-k8s-05986b97ada98f9cf1cabda6a8855c86.jpg"></p><p><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer">Chaos Meshâ„¢</a>, an easy-to-use, open-source, cloud-native chaos engineering platform for Kubernetes (K8s), has a new feature, TimeChaos, which simulates the <a href="https://en.wikipedia.org/wiki/Clock_skew#On_a_network" target="_blank" rel="noopener noreferrer">clock skew</a> phenomenon. Usually, when we modify clocks in a container, we want a <a href="https://learning.oreilly.com/library/view/chaos-engineering/9781491988459/ch07.html" target="_blank" rel="noopener noreferrer">minimized blast radius</a>, and we don&#x27;t want the change to affect the other containers on the node. In reality, however, implementing this can be harder than you think. How does Chaos Mesh solve this problem?</p><p>In this post, I&#x27;ll describe how we hacked through different approaches of clock skew and how TimeChaos in Chaos Mesh enables time to swing freely in containers.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="simulating-clock-skew-without-affecting-other-containers-on-the-node"></a>Simulating clock skew without affecting other containers on the node<a class="hash-link" href="#simulating-clock-skew-without-affecting-other-containers-on-the-node" title="Direct link to heading">#</a></h2><p>Clock skew refers to the time difference between clocks on nodes within a network. It might cause reliability problems in a distributed system, and it&#x27;s a concern for designers and developers of complex distributed systems. For example, in a distributed SQL database, it&#x27;s vital to maintain a synchronized local clock across nodes to achieve a consistent global snapshot and ensure the ACID properties for transactions.</p><p>Currently, there are well-recognized <a href="https://pingcap.com/blog/Time-in-Distributed-Systems/" target="_blank" rel="noopener noreferrer">solutions to synchronize clocks</a>, but without proper testing, you can never be sure that your implementation is solid.</p><p>Then how can we test global snapshot consistency in a distributed system? The answer is obvious: we can simulate clock skew to test whether distributed systems can keep a consistent global snapshot under abnormal clock conditions. Some testing tools support simulating clock skew in containers, but they have an impact on physical nodes.</p><p><a href="https://github.com/chaos-mesh/chaos-mesh/wiki/Time-Chaos" target="_blank" rel="noopener noreferrer">TimeChaos</a> is a tool that <strong>simulates clock skew in containers to test how it impacts your application without affecting the whole node</strong>. This way, we can precisely identify the potential consequences of clock skew and take measures accordingly.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="various-approaches-for-simulating-clock-skew-weve-explored"></a>Various approaches for simulating clock skew we&#x27;ve explored<a class="hash-link" href="#various-approaches-for-simulating-clock-skew-weve-explored" title="Direct link to heading">#</a></h2><p>Reviewing the existing choices, we know clearly that they cannot be applied to Chaos Mesh, which runs on Kubernetes. Two common ways of simulating clock skew--changing the node clock directly and using the Jepsen framework--change the time for all processes on the node. These are not acceptable solutions for us. In a Kubernetes container, if we inject a clock skew error that affects the entire node, other containers on the same node will be disturbed. Such a clumsy approach is not tolerable.</p><p>Then how are we supposed to tackle this problem? Well, the first thing that comes into our mind is finding solutions in the kernel using <a href="https://en.wikipedia.org/wiki/Berkeley_Packet_Filter" target="_blank" rel="noopener noreferrer">Berkeley Packet Filter</a> (BPF).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="ld_preload"></a><code>LD_PRELOAD</code><a class="hash-link" href="#ld_preload" title="Direct link to heading">#</a></h3><p><code>LD_PRELOAD</code> is a Linux environment variable that lets you define which dynamic link library is loaded before the program execution.</p><p>This variable has two advantages:</p><ul><li>We can call our own functions without being aware of the source code.</li><li>We can inject code into other programs to achieve specific purposes.</li></ul><p>For some languages that use applications to call the time function in glibc, such as Rust and C, using <code>LD_PRELOAD</code> is enough to simulate clock skew. But things are trickier for Golang. Because languages such as Golang directly parse virtual Dynamic Shared Object (<a href="http://man7.org/linux/man-pages/man7/vdso.7.html" target="_blank" rel="noopener noreferrer">vDSO</a>), a mechanism to speed up system calls. To obtain the time function address, we can&#x27;t simply use <code>LD_PRELOAD</code> to intercept the glic interface. Therefore, <code>LD_PRELOAD</code> is not our solution.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="use-bpf-to-modify-the-return-value-of-clock_gettime-system-call"></a>Use BPF to modify the return value of <code>clock_gettime</code> system call<a class="hash-link" href="#use-bpf-to-modify-the-return-value-of-clock_gettime-system-call" title="Direct link to heading">#</a></h3><p>We also tried to filter the task <a href="http://www.linfo.org/pid.html" target="_blank" rel="noopener noreferrer">process identification number</a> (PID) with BPF. This way, we could simulate clock skew on a specified process and modify the return value of the <code>clock_gettime</code> system call.</p><p>This seemed like a good idea, but we also encountered a problem: in most cases, vDSO speeds up <code>clock_gettime</code>, but <code>clock_gettime</code> doesn&#x27;t make a system call. This selection didn&#x27;t work, either. Oops.</p><p>Thankfully, we determined that if the system kernel version is 4.18 or later, and if we use the <a href="https://www.kernel.org/doc/html/latest/timers/hpet.html" target="_blank" rel="noopener noreferrer">HPET</a> clock, <code>clock_gettime()</code> gets time by making normal system calls instead of vDSO. We implemented <a href="https://github.com/chaos-mesh/bpfki" target="_blank" rel="noopener noreferrer">a version of clock skew</a> using this approach, and it works fine for Rust and C. As for Golang, the program can get the time right, but if we perform <code>sleep</code> during the clock skew injection, the sleep operation is very likely to be blocked. Even after the injection is canceled, the system cannot recover. Thus, we have to give up this approach, too.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="timechaos-our-final-hack"></a>TimeChaos, our final hack<a class="hash-link" href="#timechaos-our-final-hack" title="Direct link to heading">#</a></h2><p>From the previous section, we know that programs usually get the system time by calling <code>clock_gettime</code>. In our case, <code>clock_gettime</code> uses vDSO to speed up the calling process, so we cannot use <code>LD_PRELOAD</code> to hack the <code>clock_gettime</code> system calls.</p><p>We figured out the cause; then what&#x27;s the solution? Start from vDSO. If we can redirect the address that stores the <code>clock_gettime</code> return value in vDSO to an address we define, we can solve the problem.</p><p>Easier said than done. To achieve this goal, we must tackle the following problems:</p><ul><li>Know the user-mode address used by vDSO</li><li>Know vDSO&#x27;s kernel-mode address, if we want to modify the <code>clock_gettime</code> function in vDSO by any address in the kernel mode</li><li>Know how to modify vDSO data</li></ul><p>First, we need to peek inside vDSO. We can see the vDSO memory address in <code>/proc/pid/maps</code>.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-undefined codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ cat /proc/pid/maps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">7ffe53143000-7ffe53145000 r-xp 00000000 00:00 0                     [vdso]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button></div></div><p>The last line is vDSO information. The privilege of this memory space is <code>r-xp</code>: readable and executable, but not writable. That means the user mode cannot modify this memory. We can use <a href="http://man7.org/linux/man-pages/man2/ptrace.2.html" target="_blank" rel="noopener noreferrer">ptrace</a> to avoid this restriction.</p><p>Next, we use <code>gdb dump memory</code> to export the vDSO and use <code>objdump</code> to see what&#x27;s inside. Here is what we get:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-undefined codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">(gdb) dump memory vdso.so 0x00007ffe53143000 0x00007ffe53145000</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ objdump -T vdso.so</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">vdso.so:    file format elf64-x86-64</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">DYNAMIC SYMBOL TABLE:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ffffffffff700600  w  DF .text   0000000000000545  LINUX_2.6  clock_gettime</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button></div></div><p>We can see that the whole vDSO is like a <code>.so</code> file, so we can use an executable and linkable format (ELF) file to format it. With this information, a basic workflow for implementing TimeChaos starts to take shape:</p><p><img alt="TimeChaos workflow" src="/assets/images/timechaos-workflow-b9960dd4ac9c21fa72817ae910305235.jpg"></p><div class="caption-center"> TimeChaos workflow </div><p>The chart above is the process of <strong>TimeChaos</strong>, an implementation of clock skew in Chaos Mesh.</p><ol><li>Use ptrace to attach the specified PID process to stop the current process.</li><li>Use ptrace to create a new mapping in the virtual address space of the calling process and use <a href="https://linux.die.net/man/2/process_vm_writev" target="_blank" rel="noopener noreferrer"><code>process_vm_writev</code></a> to write the <code>fake_clock_gettime</code> function we defined into the memory space.</li><li>Use <code>process_vm_writev</code> to write the specified parameters into <code>fake_clock_gettime</code>. These parameters are the time we would like to inject, such as two hours backward or two days forward.</li><li>Use ptrace to modify the <code>clock_gettime</code> function in vDSO and redirect to the <code>fake_clock_gettime</code> function.</li><li>Use ptrace to detach the PID process.</li></ol><p>If you are interested in the details, see the <a href="https://github.com/chaos-mesh/chaos-mesh/blob/master/pkg/time/time_linux.go" target="_blank" rel="noopener noreferrer">Chaos Mesh GitHub repository</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="simulating-clock-skew-on-a-distributed-sql-database"></a>Simulating clock skew on a distributed SQL database<a class="hash-link" href="#simulating-clock-skew-on-a-distributed-sql-database" title="Direct link to heading">#</a></h2><p>Statistics speak volumes. Here we&#x27;re going to try TimeChaos on <a href="https://pingcap.com/docs/stable/overview/" target="_blank" rel="noopener noreferrer">TiDB</a>, an open source, <a href="https://en.wikipedia.org/wiki/NewSQL" target="_blank" rel="noopener noreferrer">NewSQL</a>, distributed SQL database that supports <a href="https://en.wikipedia.org/wiki/Hybrid_transactional/analytical_processing" target="_blank" rel="noopener noreferrer">Hybrid Transactional/Analytical Processing</a> (HTAP) workloads, to see if the chaos testing can really work.</p><p>TiDB uses a centralized service Timestamp Oracle (TSO) to obtain the globally consistent version number, and to ensure that the transaction version number increases monotonically. The TSO service is managed by the Placement Driver (PD) component. Therefore, we choose a random PD node and inject TimeChaos regularly, each with a 10-millisecond-backward clock skew. Let&#x27;s see if TiDB can meet the challenge.</p><p>To better perform the testing, we use <a href="https://github.com/cwen0/bank" target="_blank" rel="noopener noreferrer">bank</a> as the workload, which simulates the financial transfers in a banking system. It&#x27;s often used to verify the correctness of database transactions.</p><p>This is our test configuration:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-undefined codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: chaos-mesh.org/v1alpha1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kind: TimeChaos</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  name: time-skew-example</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  namespace: tidb-demo</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mode: one</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  selector:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    labelSelectors:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;app.kubernetes.io/component&quot;: &quot;pd&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  timeOffset:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    sec: -600</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  clockIds:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - CLOCK_REALTIME</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  duration: &quot;10s&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  scheduler:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    cron: &quot;@every 1m&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button></div></div><p>During this test, Chaos Mesh injects TimeChaos into a chosen PD Pod every 1 millisecond for 10 seconds. Within the duration, the time acquired by PD will have a 600 second offset from the actual time. For further details, see <a href="https://github.com/chaos-mesh/chaos-mesh/wiki/Time-Chaos" target="_blank" rel="noopener noreferrer">Chaos Mesh Wiki</a>.</p><p>Let&#x27;s create a TimeChaos experiment using the <code>kubectl apply</code> command:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-undefined codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl apply -f pd-time.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button></div></div><p>Now, we can retrieve the PD log by the following command:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-undefined codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl logs -n tidb-demo tidb-app-pd-0 | grep &quot;system time jump backward&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button></div></div><p>Here&#x27;s the log:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_3RXF"><div tabindex="0" class="prism-code language-undefined codeBlock_1wn8 thin-scrollbar"><div class="codeBlockLines_3HrO" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:06:23.164 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585041383060109693]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:16:32.260 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585041992160476622]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:20:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042231960027622]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:23:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042411960079655]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:25:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042531963640321]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:28:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042711960148191]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:33:32.063 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043011960517655]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:34:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043071959942937]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:35:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043131978582964]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:36:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043191960687755]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:38:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043311959970737]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:41:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043491959970502]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:45:32.061 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043731961304629]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button></div></div><p>From the log above, we see that every now and then, PD detects that the system time rolls back. This means:</p><ul><li>TimeChaos successfully simulates clock skew.</li><li>PD can deal with the clock skew situation.</li></ul><p>That&#x27;s encouraging. But does TimeChaos affect services other than PD? We can check it out in the Chaos Dashboard:</p><p><img alt="Chaos Dashboard" src="/assets/images/chaos-dashboard-0693a3b8da68e9c7f47c7c633dbb1f9b.jpg"></p><div class="caption-center"> Chaos Dashboard </div><p>It&#x27;s clear that in the monitor, TimeChaos was injected every 1 millisecond and the whole duration lasted 10 seconds. What&#x27;s more, TiDB was not affected by that injection. The bank program ran normally, and performance was not affected.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="try-out-chaos-mesh"></a>Try out Chaos Mesh<a class="hash-link" href="#try-out-chaos-mesh" title="Direct link to heading">#</a></h2><p>As a cloud-native chaos engineering platform, Chaos Mesh features all-around <a href="https://pingcap.com/blog/chaos-mesh-your-chaos-engineering-solution-for-system-resiliency-on-kubernetes/" target="_blank" rel="noopener noreferrer">fault injection methods for complex systems on Kubernetes</a>, covering faults in Pods, the network, the file system, and even the kernel.</p><p>Wanna have some hands-on experience in chaos engineering? Welcome to <a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer">Chaos Mesh</a>. This <a href="https://pingcap.com/blog/run-first-chaos-experiment-in-ten-minutes/" target="_blank" rel="noopener noreferrer">10-minute tutorial</a> will help you quickly get started with chaos engineering and run your first chaos experiment with Chaos Mesh.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/chaos-mesh">Chaos Mesh</a><a class="margin-horiz--sm" href="/blog/tags/chaos-engineering">Chaos Engineering</a><a class="margin-horiz--sm" href="/blog/tags/kubernetes">Kubernetes</a><a class="margin-horiz--sm" href="/blog/tags/distributed-system">Distributed System</a></div></footer></article><div><a href="https://github.com/chaos-mesh/website/edit/master/blog/2020-04-20-simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/chaos-mesh-join-cncf-sandbox-project"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Chaos MeshÂ® Joins CNCF as a Sandbox Project</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/run_your_first_chaos_experiment"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Run Your First Chaos Experiment in 10 Minutes Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#simulating-clock-skew-without-affecting-other-containers-on-the-node" class="table-of-contents__link">Simulating clock skew without affecting other containers on the node</a></li><li><a href="#various-approaches-for-simulating-clock-skew-weve-explored" class="table-of-contents__link">Various approaches for simulating clock skew we&#39;ve explored</a><ul><li><a href="#ld_preload" class="table-of-contents__link"><code>LD_PRELOAD</code></a></li><li><a href="#use-bpf-to-modify-the-return-value-of-clock_gettime-system-call" class="table-of-contents__link">Use BPF to modify the return value of <code>clock_gettime</code> system call</a></li></ul></li><li><a href="#timechaos-our-final-hack" class="table-of-contents__link">TimeChaos, our final hack</a></li><li><a href="#simulating-clock-skew-on-a-distributed-sql-database" class="table-of-contents__link">Simulating clock skew on a distributed SQL database</a></li><li><a href="#try-out-chaos-mesh" class="table-of-contents__link">Try out Chaos Mesh</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Documentation</h4><ul class="footer__items"><li class="footer__item"><a href="https://chaos-mesh.org/docs/get_started/get_started_on_kind" target="_blank" rel="noopener noreferrer" class="footer__link-item">Getting Started</a></li><li class="footer__item"><a href="https://chaos-mesh.org/docs/user_guides/installation" target="_blank" rel="noopener noreferrer" class="footer__link-item">User Guides</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/chaos_mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://join.slack.com/t/cloud-native/shared_invite/zt-fyy3b8up-qHeDNVqbz1j8HDY6g1cY4w" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack (#project-chaos-mesh)</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Others</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.netlify.com"><img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify"></a></li></ul></div></div><div class="text--center"><div>
        <br>
        <strong>Â© Chaos MeshÂ® Authors 2021 | Documentation Distributed under CC-BY-4.0 </strong>
        <br>
        <br>
        Â© 2021 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.
      </div></div></div></footer></div>
<script src="/styles.3f26a57a.js"></script>
<script src="/runtime~main.a8ac29bc.js"></script>
<script src="/main.7cc3356b.js"></script>
<script src="/1.59f8c63f.js"></script>
<script src="/2.f64c1922.js"></script>
<script src="/ccc49370.5c7c61e4.js"></script>
<script src="/e3f34e86.93b6458b.js"></script>
<script src="/6897adcd.4060e1b5.js"></script>
</body>
</html>