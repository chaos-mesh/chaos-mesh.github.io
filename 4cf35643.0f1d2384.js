(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{101:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return l})),a.d(t,"metadata",(function(){return c})),a.d(t,"rightToc",(function(){return s})),a.d(t,"default",(function(){return h}));var o=a(3),n=a(7),r=(a(0),a(198)),l={id:"develop_a_new_chaos",title:"Develop a New Chaos",sidebar_label:"Develop a New Chaos"},c={unversionedId:"development_guides/develop_a_new_chaos",id:"version-0.9.1/development_guides/develop_a_new_chaos",isDocsHomePage:!1,title:"Develop a New Chaos",description:'After preparing the development environment, let\'s develop a new type of chaos, HelloWorldChaos, which only prints a "Hello World!" message to the log. Generally, to add a new chaos type for Chaos Mesh, you need to take the following steps:',source:"@site/versioned_docs/version-0.9.1/development_guides/dev_hello_world.md",slug:"/development_guides/develop_a_new_chaos",permalink:"/docs/0.9.1/development_guides/develop_a_new_chaos",editUrl:"https://github.com/chaos-mesh/website/edit/master/versioned_docs/version-0.9.1/development_guides/dev_hello_world.md",version:"0.9.1",sidebar_label:"Develop a New Chaos",sidebar:"version-0.9.1/docs",previous:{title:"Set up the development environment",permalink:"/docs/0.9.1/development_guides/set_up_the_development_environment"},next:{title:"FAQs",permalink:"/docs/0.9.1/faqs"}},s=[{value:"Add the chaos object in controller",id:"add-the-chaos-object-in-controller",children:[]},{value:"Register the CRD",id:"register-the-crd",children:[]},{value:"Implement the schema type",id:"implement-the-schema-type",children:[]},{value:"Make the Docker image",id:"make-the-docker-image",children:[]},{value:"Run chaos",id:"run-chaos",children:[]},{value:"Next steps",id:"next-steps",children:[]}],i={rightToc:s};function h(e){var t=e.components,a=Object(n.a)(e,["components"]);return Object(r.b)("wrapper",Object(o.a)({},i,a,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"After ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"/docs/0.9.1/development_guides/set_up_the_development_environment"}),"preparing the development environment"),', let\'s develop a new type of chaos, HelloWorldChaos, which only prints a "Hello World!" message to the log. Generally, to add a new chaos type for Chaos Mesh, you need to take the following steps:'),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"#add-the-chaos-object-in-controller"}),"Add the chaos object in controller")),Object(r.b)("li",{parentName:"ol"},Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"#register-the-crd"}),"Register the CRD")),Object(r.b)("li",{parentName:"ol"},Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"#implement-the-schema-type"}),"Implement the schema type")),Object(r.b)("li",{parentName:"ol"},Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"#make-the-docker-image"}),"Make the Docker image")),Object(r.b)("li",{parentName:"ol"},Object(r.b)("a",Object(o.a)({parentName:"li"},{href:"#run-chaos"}),"Run chaos"))),Object(r.b)("h2",{id:"add-the-chaos-object-in-controller"},"Add the chaos object in controller"),Object(r.b)("p",null,"In Chaos Mesh, all chaos types are managed by the controller manager. To add a new chaos type, you need to start from adding the corresponding reconciler type in the controller, as instructed in the following steps:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Add the HelloWorldChaos object in the controller manager ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/chaos-mesh/chaos-mesh/blob/master/cmd/controller-manager/main.go#L104"}),"main.go"),"."),Object(r.b)("p",{parentName:"li"},"You will notice existing chaos types such as PodChaos, NetworkChaos and IOChaos. Add the new type below them:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-go"}),'    if err = (&controllers.HelloWorldChaosReconciler{\n        Client: mgr.GetClient(),\n        Log:    ctrl.Log.WithName("controllers").WithName("HelloWorldChaos"),\n    }).SetupWithManager(mgr); err != nil {\n        setupLog.Error(err, "unable to create controller", "controller", "HelloWorldChaos")\n        os.Exit(1)\n    }\n'))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Under ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/chaos-mesh/chaos-mesh/tree/master/controllers"}),"controllers"),", create a ",Object(r.b)("inlineCode",{parentName:"p"},"helloworldchaos_controller.go")," file and edit it as below:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-go"}),'package controllers\n\nimport (\n  "github.com/go-logr/logr"\n\n  chaosmeshv1alpha1 "github.com/chaos-mesh/chaos-mesh/api/v1alpha1"\n\n  ctrl "sigs.k8s.io/controller-runtime"\n  "sigs.k8s.io/controller-runtime/pkg/client"\n)\n\n// HelloWorldChaosReconciler reconciles a HelloWorldChaos object\ntype HelloWorldChaosReconciler struct {\n  client.Client\n  Log logr.Logger\n}\n\n// +kubebuilder:rbac:groups=chaos-mesh.org,resources=helloworldchaos,verbs=get;list;watch;create;update;patch;delete\n// +kubebuilder:rbac:groups=chaos-mesh.org,resources=helloworldchaos/status,verbs=get;update;patch\n\nfunc (r *HelloWorldChaosReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {\n  logger := r.Log.WithValues("reconciler", "helloworldchaos")\n\n  // the main logic of `HelloWorldChaos`, it prints a log `Hello World!` and returns nothing.\n  logger.Info("Hello World!")\n\n  return ctrl.Result{}, nil\n}\n\nfunc (r *HelloWorldChaosReconciler) SetupWithManager(mgr ctrl.Manager) error {\n// exports `HelloWorldChaos` object, which represents the yaml schema content the user applies.\nreturn ctrl.NewControllerManagedBy(mgr).\n  For(&chaosmeshv1alpha1.HelloWorldChaos{}).\n  Complete(r)\n}\n')))),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},Object(r.b)("strong",{parentName:"p"},"Note:")),Object(r.b)("p",{parentName:"blockquote"},"The comment ",Object(r.b)("inlineCode",{parentName:"p"},"// +kubebuilder:rbac:groups=chaos-mesh.org...")," is an authority control mechanism that decides which account can access this reconciler. To make it accessible by the dashboard and chaos-controller-manager, you need to modify ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/chaos-mesh/chaos-mesh/blob/master/helm/chaos-mesh/templates/controller-manager-rbac.yaml"}),"controller-manager-rbac.yaml")," accordingly:")),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),"- apiGroups: ['chaos-mesh.org']\n  resources:\n    - podchaos\n    - networkchaos\n    - iochaos\n    - helloworldchaos # Add this line in all chaos-mesh.org group\n  verbs: ['*']\n")),Object(r.b)("h2",{id:"register-the-crd"},"Register the CRD"),Object(r.b)("p",null,"The HelloWorldChaos object is a custom resource object in Kubernetes. This means you need to register the corresponding CRD in the Kubernetes API. To do this, modify ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/chaos-mesh/chaos-mesh/blob/master/config/crd/kustomization.yaml"}),"kustomization.yaml")," by adding the corresponding line as shown below:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),"resources:\n  - bases/chaos-mesh.org_podchaos.yaml\n  - bases/chaos-mesh.org_networkchaos.yaml\n  - bases/chaos-mesh.org_iochaos.yaml\n  - bases/chaos-mesh.org_helloworldchaos.yaml # this is the new line\n")),Object(r.b)("h2",{id:"implement-the-schema-type"},"Implement the schema type"),Object(r.b)("p",null,"To implement the schema type for the new chaos object, add ",Object(r.b)("inlineCode",{parentName:"p"},"helloworldchaos_types.go")," in the ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/chaos-mesh/chaos-mesh/tree/master/api/v1alpha1"}),"api directory")," and modify it as below:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-go"}),'package v1alpha1\n\nimport (\n    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"\n)\n\n// +kubebuilder:object:root=true\n\n// HelloWorldChaos is the Schema for the helloworldchaos API\ntype HelloWorldChaos struct {\n    metav1.TypeMeta   `json:",inline"`\n    metav1.ObjectMeta `json:"metadata,omitempty"`\n}\n\n// +kubebuilder:object:root=true\n\n// HelloWorldChaosList contains a list of HelloWorldChaos\ntype HelloWorldChaosList struct {\n    metav1.TypeMeta `json:",inline"`\n    metav1.ListMeta `json:"metadata,omitempty"`\n    Items           []HelloWorldChaos `json:"items"`\n}\n\nfunc init() {\n    SchemeBuilder.Register(&HelloWorldChaos{}, &HelloWorldChaosList{})\n}\n')),Object(r.b)("p",null,"With this file added, the HelloWorldChaos schema type is defined and can be called by the following YAML lines:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),"apiVersion: chaos-mesh.org/v1alpha1\nkind: HelloWorldChaos\nmetadata:\n  name: <name-of-this-resource>\n  namespace: <ns-of-this-resource>\n")),Object(r.b)("h2",{id:"make-the-docker-image"},"Make the Docker image"),Object(r.b)("p",null,"Having the object successfully added, you can make a Docker image and push it to your registry:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-bash"}),"make\nmake docker-push\n")),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},Object(r.b)("strong",{parentName:"p"},"Note:")),Object(r.b)("p",{parentName:"blockquote"},"The default ",Object(r.b)("inlineCode",{parentName:"p"},"DOCKER_REGISTRY")," is ",Object(r.b)("inlineCode",{parentName:"p"},"localhost:5000"),", which is preset in ",Object(r.b)("inlineCode",{parentName:"p"},"hack/kind-cluster-build.sh"),". You can overwrite it to any registry to which you have access permission.")),Object(r.b)("h2",{id:"run-chaos"},"Run chaos"),Object(r.b)("p",null,"You are almost there. In this step, you will pull the image and apply it for testing."),Object(r.b)("p",null,"Before you pull any image for Chaos Mesh (using ",Object(r.b)("inlineCode",{parentName:"p"},"helm install")," or ",Object(r.b)("inlineCode",{parentName:"p"},"helm upgrade"),"), modify ",Object(r.b)("a",Object(o.a)({parentName:"p"},{href:"https://github.com/chaos-mesh/chaos-mesh/blob/master/helm/chaos-mesh/values.yaml"}),"values.yaml")," of helm template to replace the default image with what you just pushed to your local registry."),Object(r.b)("p",null,"In this case, the template uses ",Object(r.b)("inlineCode",{parentName:"p"},"pingcap/chaos-mesh:latest")," as the default target registry, so you need to replace it with ",Object(r.b)("inlineCode",{parentName:"p"},"localhost:5000"),", as shown below:"),Object(r.b)("pre",null,Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),"clusterScoped: true\n\n# Also see clusterScoped and controllerManager.serviceAccount\nrbac:\n  create: true\n\ncontrollerManager:\n  serviceAccount: chaos-controller-manager\n  ...\n  image: localhost:5000/pingcap/chaos-mesh:latest\n  ...\nchaosDaemon:\n  image: localhost:5000/pingcap/chaos-daemon:latest\n  ...\ndashboard:\n  image: localhost:5000/pingcap/chaos-dashboard:latest\n  ...\n")),Object(r.b)("p",null,"Now take the following steps to run chaos:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Get the related custom resource type for Chaos Mesh:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-bash"}),"kubectl apply -f manifests/\nkubectl get crd podchaos.chaos-mesh.org\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Install Chaos Mesh:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-bash"}),"helm install helm/chaos-mesh --name=chaos-mesh --namespace=chaos-testing --set chaosDaemon.runtime=containerd --set chaosDaemon.socketPath=/run/containerd/containerd.sock\nkubectl get pods --namespace chaos-testing -l app.kubernetes.io/instance=chaos-mesh\n")),Object(r.b)("p",{parentName:"li"},"The arguments ",Object(r.b)("inlineCode",{parentName:"p"},"--set chaosDaemon.runtime=containerd --set chaosDaemon.socketPath=/run/containerd/containerd.sock")," is used to to support network chaos on kind.")),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Create ",Object(r.b)("inlineCode",{parentName:"p"},"chaos.yaml")," in any location with the lines below:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),"apiVersion: chaos-mesh.org/v1alpha1\nkind: HelloWorldChaos\nmetadata:\n  name: hello-world\n  namespace: chaos-testing\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"Apply the chaos:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-bash"}),"kubectl apply -f /path/to/chaos.yaml\nkubectl get HelloWorldChaos -n chaos-testing\n")),Object(r.b)("p",{parentName:"li"},"Now you should be able to check the ",Object(r.b)("inlineCode",{parentName:"p"},"Hello World!")," result in the log:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(o.a)({parentName:"pre"},{className:"language-bash"}),"kubectl logs chaos-controller-manager-{pod-post-fix} -n chaos-testing\n")),Object(r.b)("blockquote",{parentName:"li"},Object(r.b)("p",{parentName:"blockquote"},Object(r.b)("strong",{parentName:"p"},"Note:")),Object(r.b)("p",{parentName:"blockquote"},Object(r.b)("inlineCode",{parentName:"p"},"{pod-post-fix}")," is a random string generated by Kubernetes, you can check it by executing ",Object(r.b)("inlineCode",{parentName:"p"},"kubectl get po -n chaos-testing"),".")))),Object(r.b)("h2",{id:"next-steps"},"Next steps"),Object(r.b)("p",null,"Congratulations! You have just added a chaos type for Chaos Mesh successfully. Let us know if you run into any issues during the process. If you feel like doing other types of contributions, refer to Add facilities to chaos daemon (WIP)."))}h.isMDXComponent=!0},198:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return d}));var o=a(0),n=a.n(o);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function c(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var i=n.a.createContext({}),h=function(e){var t=n.a.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):c(c({},t),e)),a},p=function(e){var t=h(e.components);return n.a.createElement(i.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return n.a.createElement(n.a.Fragment,{},t)}},m=n.a.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,i=s(e,["components","mdxType","originalType","parentName"]),p=h(a),m=o,d=p["".concat(l,".").concat(m)]||p[m]||b[m]||r;return a?n.a.createElement(d,c(c({ref:t},i),{},{components:a})):n.a.createElement(d,c({ref:t},i))}));function d(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,l=new Array(r);l[0]=m;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:o,l[1]=c;for(var i=2;i<r;i++)l[i]=a[i];return n.a.createElement.apply(null,l)}return n.a.createElement.apply(null,a)}m.displayName="MDXCreateElement"}}]);