(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{131:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return p}));var a=n(2),o=n(6),r=(n(0),n(150)),i={id:"sidecar_template",title:"Sidecar Template",sidebar_label:"Sidecar Template"},c={id:"user_guides/sidecar_template",title:"Sidecar Template",description:"The following content is the common template ConfigMap defined for injecting IOChaos sidecar, you can also find this example here:",source:"@site/docs/user_guides/sidecar_template.md",permalink:"/docs/user_guides/sidecar_template",editUrl:"https://github.com/pingcap/chaos-mesh/edit/master/website/docs/user_guides/sidecar_template.md",sidebar_label:"Sidecar Template",sidebar:"docs",previous:{title:"Sidecar ConfigMap",permalink:"/docs/user_guides/sidecar_configmap"},next:{title:"Development Guide",permalink:"/docs/development_guides/development_overview"}},s=[],l={rightToc:s};function p(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"The following content is the common template ConfigMap defined for injecting IOChaos sidecar, you can also find this example ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"../manifests/chaosfs-sidecar.yaml"}),"here"),":"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'---\napiVersion: v0\nkind: ConfigMap\nmetadata:\n  name: chaosfs-sidecar\n  labels:\n    app.kubernetes.io/component: template\ndata:\n  data: |\n    initContainers:\n    - name: inject-scripts\n      image: pingcap/chaos-scripts:latest\n      imagePullPolicy: Always\n      command: ["sh", "-c", "/scripts/init.sh -d {{.DataPath}} -f {{.MountPath}}/fuse-data"]\n    containers:\n    - name: chaosfs\n      image: pingcap/chaos-fs:latest\n      imagePullPolicy: Always\n      ports:\n      - containerPort: 65533\n      securityContext:\n        privileged: true\n      command:\n        - /usr/local/bin/chaosfs\n        - -addr=:65533\n        - -pidfile=/tmp/fuse/pid\n        - -original={{.MountPath}}/fuse-data\n        - -mountpoint={{.DataPath}}\n      volumeMounts:\n        - name: {{.VolumeName}}\n          mountPath: {{.MountPath}}\n          mountPropagation: Bidirectional\n    volumeMounts:\n    - name: {{.VolumeName}}\n      mountPath: {{.MountPath}}\n      mountPropagation: HostToContainer\n    - name: scripts\n      mountPath: /tmp/scripts\n    - name: fuse\n      mountPath: /tmp/fuse\n    volumes:\n    - name: scripts\n      emptyDir: {}\n    - name: fuse\n      emptyDir: {}\n    postStart:\n      {{.ContainerName}}:\n        command:\n          - /tmp/scripts/wait-fuse.sh\n')),Object(r.b)("p",null,"Template config defines some variables by ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://golang.org/pkg/text/template/"}),"Go Template")," mechanism. This example has four arguments:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"DataPath: original data directory"),Object(r.b)("li",{parentName:"ul"},"MountPath: after injecting chaosfs sidecar, data directory will be mounted to {{.MountPath}}/fuse-data"),Object(r.b)("li",{parentName:"ul"},"VolumeName: the data volume name used by the pod"),Object(r.b)("li",{parentName:"ul"},"ContainerName: to which container the sidecar is injected")),Object(r.b)("p",null,"For fields defined in this template, we have some brief descriptions below:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"initContainers"),": defines the ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://kubernetes.io/docs/concepts/workloads/pods/init-containers/"}),"initContainer")," need to be injected."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"container"),": defines the sidecar container need to be injected."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"volumeMounts"),": defines the new volumeMounts or overwrite the old volumeMounts of each containers in target pods."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"volume"),": defines the new volumes for the target pod or overwrite the old volumes in target pods."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("strong",{parentName:"li"},"postStart"),": called after a container is created first. If the handler fails, the containers will failed.")),Object(r.b)("blockquote",null,Object(r.b)("p",{parentName:"blockquote"},Object(r.b)("strong",{parentName:"p"},"Note:")),Object(r.b)("p",{parentName:"blockquote"},"Chaos controller-manager only watches template config map with the label selector specified by its flag ",Object(r.b)("inlineCode",{parentName:"p"},"--template-labels"),", by default this label\nis ",Object(r.b)("inlineCode",{parentName:"p"},"app.kubernetes.io/component=template")," if your Chaos Mesh is deployed by Helm."),Object(r.b)("p",{parentName:"blockquote"},"Each template config map should be deployed in the same namespace as Chaos Mesh, and it is identified by the name of the config map, which is ",Object(r.b)("inlineCode",{parentName:"p"},"chaosfs-sidecar")," in the above example."),Object(r.b)("p",{parentName:"blockquote"},"The template config content should be in the ",Object(r.b)("inlineCode",{parentName:"p"},"data")," field. This means it is not possible to define two templates in one config map, you have to use two config maps like the example below.")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),"---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: chaosfs-sidecar0\n  labels:\n    app.kubernetes.io/component: template\ndata:\n  data: |\n    xxxx\n\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: chaosfs-sidecar1\n  labels:\n    app.kubernetes.io/component: template\ndata:\n  data: |\n    xxxx\n")))}p.isMDXComponent=!0},150:function(e,t,n){"use strict";n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return b}));var a=n(0),o=n.n(a);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=o.a.createContext({}),p=function(e){var t=o.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},m=function(e){var t=p(e.components);return o.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},d=o.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,i=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),m=p(n),d=a,b=m["".concat(i,".").concat(d)]||m[d]||u[d]||r;return n?o.a.createElement(b,c(c({ref:t},l),{},{components:n})):o.a.createElement(b,c({ref:t},l))}));function b(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=d;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var l=2;l<r;l++)i[l]=n[l];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);