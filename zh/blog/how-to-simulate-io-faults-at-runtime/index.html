<!doctype html>
<html lang="zh" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">How to Simulate I/O Faults at Runtime | Chaos Mesh</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chaos-mesh.org/zh/blog/how-to-simulate-io-faults-at-runtime/"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="How to Simulate I/O Faults at Runtime | Chaos Mesh"><meta data-rh="true" name="description" content="Chaos Engineering - How to simulate I/O faults at runtime"><meta data-rh="true" property="og:description" content="Chaos Engineering - How to simulate I/O faults at runtime"><meta data-rh="true" property="og:image" content="https://chaos-mesh.org/zh/img/blog/how-to-simulate-io-faults-at-runtime.jpg"><meta data-rh="true" name="twitter:image" content="https://chaos-mesh.org/zh/img/blog/how-to-simulate-io-faults-at-runtime.jpg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-01-08T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/YangKeao"><meta data-rh="true" property="article:tag" content="Chaos Mesh,Chaos Engineering,Fault Injection"><link data-rh="true" rel="icon" href="/zh/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chaos-mesh.org/zh/blog/how-to-simulate-io-faults-at-runtime/"><link data-rh="true" rel="alternate" href="https://chaos-mesh.org/blog/how-to-simulate-io-faults-at-runtime/" hreflang="en"><link data-rh="true" rel="alternate" href="https://chaos-mesh.org/zh/blog/how-to-simulate-io-faults-at-runtime/" hreflang="zh"><link data-rh="true" rel="alternate" href="https://chaos-mesh.org/blog/how-to-simulate-io-faults-at-runtime/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://3BY0S3HQX6-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://chaos-mesh.org/zh/blog/how-to-simulate-io-faults-at-runtime","mainEntityOfPage":"https://chaos-mesh.org/zh/blog/how-to-simulate-io-faults-at-runtime","url":"https://chaos-mesh.org/zh/blog/how-to-simulate-io-faults-at-runtime","headline":"How to Simulate I/O Faults at Runtime","name":"How to Simulate I/O Faults at Runtime","description":"Chaos Engineering - How to simulate I/O faults at runtime","datePublished":"2021-01-08T00:00:00.000Z","author":{"@type":"Person","name":"Keao Yang","description":"Maintainer of Chaos Mesh","url":"https://github.com/YangKeao","image":"https://avatars.githubusercontent.com/u/5244316?v=4"},"image":{"@type":"ImageObject","@id":"https://chaos-mesh.org/zh/img/blog/how-to-simulate-io-faults-at-runtime.jpg","url":"https://chaos-mesh.org/zh/img/blog/how-to-simulate-io-faults-at-runtime.jpg","contentUrl":"https://chaos-mesh.org/zh/img/blog/how-to-simulate-io-faults-at-runtime.jpg","caption":"title image for the blog post: How to Simulate I/O Faults at Runtime"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://chaos-mesh.org/zh/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Chaos Mesh RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Chaos Mesh Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T31S4LR9LL"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-T31S4LR9LL",{})</script>



<link rel="search" type="application/opensearchdescription+xml" title="Chaos Mesh" href="/zh/opensearch.xml">

<link rel="preconnect" href="https://www.clarity.ms">
<script>!function(t,e,n,c,r,s,a){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(c)).async=1,s.src="https://www.clarity.ms/tag/lggqck9srz",(a=e.getElementsByTagName(c)[0]).parentNode.insertBefore(s,a)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/zh/assets/css/styles.e99cfd16.css">
<script src="/zh/assets/js/runtime~main.e44859fe.js" defer="defer"></script>
<script src="/zh/assets/js/main.61f5be85.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_VprB" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_gm8K"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/logos/logo-mini.svg" alt="Chaos Mesh" class="themedComponent_wXoC themedComponent--light_HvHy"><img src="/zh/img/logos/logo-mini-white.svg" alt="Chaos Mesh" class="themedComponent_wXoC themedComponent--dark_JLbL"></div><b class="navbar__title text--truncate">Chaos Mesh</b></a><a class="navbar__item navbar__link" href="/zh/docs/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog/">博客</a><a href="https://community.cncf.io/chaos-mesh-community/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">社团<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_WtTX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/zh/docs/">2.7.1</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/">Next</a></li><li><a class="dropdown__link" href="/zh/docs/">2.7.1</a></li><li><a class="dropdown__link" href="/zh/docs/2.6.6/">2.6.6</a></li><li><a class="dropdown__link" href="/zh/docs/2.5.2/">2.5.2</a></li><li class=""><hr style="margin: .5em 0;"></li><li><a class="dropdown__link" href="/zh/versions/">All Versions</a></li><li><a class="dropdown__link" href="/zh/supported-releases/">Supported Releases</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_xvpk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/blog/how-to-simulate-io-faults-at-runtime/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh/blog/how-to-simulate-io-faults-at-runtime/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">简体中文</a></li></ul></div><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub"></a><div class="toggle_JMiF colorModeToggle_VyTq"><button class="clean-btn toggleButton_R5El toggleButtonDisabled_ni1X" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_UtZQ"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_hr4M"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_lWAT"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_ZIuv"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_eAMg thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_cVoO margin-bottom--md">最近的文章</div><div role="group"><h3 class="yearGroupHeading_Nx7u">2022</h3><ul class="sidebarItemList_bJt8 clean-list"><li class="sidebarItem_Ttzz"><a class="sidebarItemLink_TQJ7" href="/zh/blog/chaos-mesh-qa-at-kubecon-eu-2022/">Chaos Mesh Q&amp;A at KUBECON EU 2022</a></li><li class="sidebarItem_Ttzz"><a class="sidebarItemLink_TQJ7" href="/zh/blog/experience-as-a-chaos-mesh-lfx-mentee/">Experience as an LFX Mentee for Chaos Mesh</a></li><li class="sidebarItem_Ttzz"><a class="sidebarItemLink_TQJ7" href="/zh/blog/develop-a-daily-reporting-system/">How to Develop a Daily Reporting System to Track Chaos Testing Results</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_Nx7u">2021</h3><ul class="sidebarItemList_bJt8 clean-list"><li class="sidebarItem_Ttzz"><a class="sidebarItemLink_TQJ7" href="/zh/blog/share-your-chaos-mesh-story/">Share your #ChaosMeshStory!</a></li><li class="sidebarItem_Ttzz"><a class="sidebarItemLink_TQJ7" href="/zh/blog/deploy-chaos-mesh-on-kubesphere/">Deploy Chaos Mesh on KubeSphere</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_ZFnQ">How to Simulate I/O Faults at Runtime</h1><div class="container_AKGX margin-vert--md"><time datetime="2021-01-08T00:00:00.000Z">2021年1月8日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_VHX3"><div class="avatar margin-bottom--sm"><a href="https://github.com/YangKeao" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_j0s_" src="https://avatars.githubusercontent.com/u/5244316?v=4" alt="Keao Yang"></a><div class="avatar__intro authorDetails_ou41"><div class="avatar__name"><a href="https://github.com/YangKeao" target="_blank" rel="noopener noreferrer"><span class="authorName_IzGa">Keao Yang</span></a></div><small class="authorTitle_VR7C" title="Maintainer of Chaos Mesh">Maintainer of Chaos Mesh</small><div class="authorSocials_k6N5"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p></p><figure><img decoding="async" loading="lazy" alt="Chaos Engineering - How to simulate I/O faults at runtime" src="/zh/assets/images/how-to-simulate-io-faults-at-runtime-39daaf89aa83a5be58402f763db0d5c5.jpg" width="3126" height="1043" class="img_xWZi"><figcaption class="text--italic text--center" style="color:var(--ifm-color-content-secondary);font-size:0.875rem">Chaos Engineering - How to simulate I/O faults at runtime</figcaption></figure><p></p>
<p>In a production environment, filesystem faults might occur due to various incidents such as disk failures and administrator errors. As a Chaos Engineering platform, Chaos Mesh has supported simulating I/O faults in a filesystem ever since its early versions. By simply adding an IOChaos CustomResourceDefinition (CRD), we can watch how the filesystem fails and returns errors.</p>
<p>However, before Chaos Mesh 1.0, this experiment was not easy and may have consumed a lot of resources. We needed to inject sidecar containers to the Pod through the mutating admission webhooks and rewrite the <code>ENTRYPOINT</code> command. Even if no fault was injected, the injected sidecar container caused a substantial amount of overhead.</p>
<p>Chaos Mesh 1.0 has changed all this. Now, we can use IOChaos to inject faults to a filesystem at runtime. This simplifies the process and greatly reduces system overhead. This blog post introduces how we implement the IOChaos experiment without using a sidecar.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_xHUa" id="io-fault-injection">I/O fault injection<a href="#io-fault-injection" class="hash-link" aria-label="I/O fault injection的直接链接" title="I/O fault injection的直接链接">​</a></h2>
<p>To simulate I/O faults at runtime, we need to inject faults into a filesystem after the program starts <a href="https://man7.org/linux/man-pages/man2/syscall.2.html" target="_blank" rel="noopener noreferrer">system calls</a> (such as reads and writes) but before the call requests arrive at the target filesystem. We can do that in one of two ways:</p>
<ul>
<li>Use Berkeley Packet Filter (BPF); however, it <a href="https://github.com/iovisor/bcc/issues/2336" target="_blank" rel="noopener noreferrer">cannot be used to inject delay</a>.</li>
<li>Add a filesystem layer called ChaosFS before the target filesystem. ChaosFS uses the target filesystem as the backend and receives requests from the operating system. The entire call link is <strong>target program syscall</strong> -&gt; <strong>Linux kernel</strong> -&gt; <strong>ChaosFS</strong> -&gt; <strong>target filesystem</strong>. Because ChaosFS is customizable, we can inject delays and errors as we want. Therefore, ChaosFS is our choice.</li>
</ul>
<p>But ChaosFS has several problems:</p>
<ul>
<li>If ChaosFS reads and writes files in the target filesystem, we need to <a href="https://man7.org/linux/man-pages/man2/mount.2.html" target="_blank" rel="noopener noreferrer">mount</a> ChaosFS to a different path than the target path specified in the Pod configuration. ChaosFS <strong>cannot</strong> be mounted to the path of the target directory.</li>
<li>We need to mount ChaosFS <strong>before</strong> the target program starts running. This is because the newly-mounted ChaosFS takes effect only on files that are newly opened by the program in the target filesystem.</li>
<li>We need to mount ChaosFS to the target containter&#x27;s <code>mnt</code> namespace. For details, see <a href="https://man7.org/linux/man-pages/man7/mount_namespaces.7.html" target="_blank" rel="noopener noreferrer">mount_namespaces(7) — Linux manual page</a>.</li>
</ul>
<p>Before Chaos Mesh 1.0, we used the <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noopener noreferrer">mutating admission webhook</a> to implement IOChaos. This technique addressed the three problems lists above and allowed us to:</p>
<ul>
<li>Run scripts in the target container. This action changed the target directory of the ChaosFS&#x27;s backend filesystem (for example, from <code>/mnt/a</code> to <code>/mnt/a_bak</code>) so that we could mount ChaosFS to the target path (<code>/mnt/a</code>). Modify the command that starts the Pod. For example, we could modify the original command <code>/app</code> to <code>/waitfs.sh /app</code>.</li>
<li>The <code>waitfs.sh</code> script kept checking whether the filesystem was successfully mounted. If it was mounted, <code>/app</code> was started.</li>
<li>Add a new container in the Pod to run ChaosFS. This container needed to share a volume with the target container (for example, <code>/mnt</code>), and then we mounted this volume to the target directory (for example, <code>/mnt/a</code>). We also properly enabled <a href="https://kubernetes.io/docs/concepts/storage/volumes/#mount-propagation" target="_blank" rel="noopener noreferrer">mount propagation</a> for this volume&#x27;s mount to penetrate the share to host and then penetrate slave to the target.</li>
</ul>
<p>These three approaches allowed us to inject I/O faults while the program was running. However, the injection was far from convenient:</p>
<ul>
<li>We could only inject faults into a volume subdirectory, not into the entire volume. The workaround was to replace <code>mv</code> (rename) with <code>mount move</code> to move the mount point of the target volume.</li>
<li>We had to explicitly write commands in the Pod rather than implicitly use the image commands. Otherwise, the <code>/waitfs.sh</code> script could not properly start the program after the filesystem was mounted.</li>
<li>The corresponding container needed to have a proper configuration for mount propagation. Due to potential privacy and security issues, we <strong>could not</strong> modify the configuration via the mutating admission webhook.</li>
<li>The injection configuration was troublesome. Worse still, we had to create a new Pod after the configuration was able to inject faults.</li>
<li>We could not withdraw ChaosFS while the program was running. Even if no fault or error was injected, the performance was greatly affected.</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_xHUa" id="inject-io-faults-without-the-mutating-admission-webhook">Inject I/O faults without the mutating admission webhook<a href="#inject-io-faults-without-the-mutating-admission-webhook" class="hash-link" aria-label="Inject I/O faults without the mutating admission webhook的直接链接" title="Inject I/O faults without the mutating admission webhook的直接链接">​</a></h2>
<p>What about cracking these tough nuts without the mutating admission webhook? Let&#x27;s get back and think a bit about the reason why we used the mutating admission webhook to add a container in which ChaosFS runs. We do that to mount the filesystem to the target container.</p>
<p>In fact, there is another solution. Instead of adding containers to the Pod, we can first use the <code>setns</code> Linux system call to modify the namespace of the current process and then use the <code>mount</code> call to mount ChaosFS to the target container. Suppose that the filesystem to inject is <code>/mnt</code>. The new injection process is as follows:</p>
<ol>
<li>Use <code>setns</code> for the current process to enter the mnt namespace of the target container.</li>
<li>Execute <code>mount --move</code> to move <code>/mnt</code> to <code>/mnt_bak</code>.</li>
<li>Mount ChaosFS to <code>/mnt</code> and use <code>/mnt_bak</code> as the backend.</li>
</ol>
<p>After the process is finished, the target container will open, read, and write the files in <code>/mnt</code> through ChaosFS. In this way, delays or faults are injected much more easily. However, there are still two questions to answer:</p>
<ul>
<li>How do you handle the files that are already opened by the target process?</li>
<li>How do you recover the process given that we cannot unmount the filesystem when files are opened?</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_xHUa" id="dynamically-replace-file-descriptors">Dynamically replace file descriptors<a href="#dynamically-replace-file-descriptors" class="hash-link" aria-label="Dynamically replace file descriptors的直接链接" title="Dynamically replace file descriptors的直接链接">​</a></h3>
<p><strong>ptrace solves both of the two questions above.</strong> We can use ptrace to replace the opened file descriptors (FD) at runtime and replace the current working directory (CWD) and mmap.</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_xHUa" id="use-ptrace-to-allow-a-tracee-to-run-a-binary-program">Use ptrace to allow a tracee to run a binary program<a href="#use-ptrace-to-allow-a-tracee-to-run-a-binary-program" class="hash-link" aria-label="Use ptrace to allow a tracee to run a binary program的直接链接" title="Use ptrace to allow a tracee to run a binary program的直接链接">​</a></h4>
<p><a href="https://man7.org/linux/man-pages/man2/ptrace.2.html" target="_blank" rel="noopener noreferrer">ptrace</a> is a powerful tool that makes the target process (tracee) to run any system call or binary program. For a tracee to run the program, ptrace modifies the RIP-pointed address to the target process and adds an <code>int3</code> instruction to trigger a breakpoint. When the binary program stops, we need to restore the registers and memory.</p>
<blockquote>
<p><strong>Note:</strong></p>
<p>In the <a href="https://en.wikipedia.org/wiki/X86_assembly_language" target="_blank" rel="noopener noreferrer">x86_64 architecture</a>, the RIP register (also called an instruction pointer) always points to the memory address at which the next directive is run. To load the program into the target process memory spaces:</p>
</blockquote>
<ol>
<li>Use ptrace to call mmap in the target program to allocate the needed memory.</li>
<li>Write the binary program to the newly allocated memory and make the RIP register point to it.</li>
<li>After the binary program stops, call munmap to clean up the memory section.</li>
</ol>
<p>As a best practice, we often replace ptrace <code>POKE_TEXT</code> writes with <code>process_vm_writev</code> because if there is a huge amount of data to write, <code>process_vm_writev</code> performs more efficiently.</p>
<p>Using ptrace, we are able to make a process to replace its own FD. Now we only need a method to make that replacement happen. This method is the <code>dup2</code> system call.</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_xHUa" id="use-dup2-to-replace-file-descriptor">Use <code>dup2</code> to replace file descriptor<a href="#use-dup2-to-replace-file-descriptor" class="hash-link" aria-label="use-dup2-to-replace-file-descriptor的直接链接" title="use-dup2-to-replace-file-descriptor的直接链接">​</a></h4>
<p>The signature of the <code>dup2</code> function is <code>int dup2(int oldfd, int newfd);</code>. It is used to create a copy of the old FD (<code>oldfd</code>). This copy has an FD number of <code>newfd</code>. If <code>newfd</code> already corresponds to the FD of an opened file, the FD on the file that&#x27;s already opened is automatically closed.</p>
<p>For example, the current process opens <code>/var/run/__chaosfs__test__/a</code> whose FD is <code>1</code>. To replace this opened file with <code>/var/run/test/a</code>, this process performs the following operations:</p>
<ol>
<li>Uses the <code>fcntl</code> system call to get the <code>OFlags</code> (the parameter used by the <code>open</code> system call, such as <code>O_WRONLY</code>) of <code>/var/run/__chaosfs__test__/a</code>.</li>
<li>Uses the <code>Iseek</code> system call to get the current location of <code>seek</code>.</li>
<li>Uses the <code>open</code> system call to open <code>/var/run/test/a</code> using the same <code>OFlags</code>. Assume that the FD is <code>2</code>.</li>
<li>Uses <code>Iseek</code> to change the <code>seek</code> location of the newly opened FD <code>2</code>.</li>
<li>Uses <code>dup2(2, 1)</code> to replace the FD <code>1</code> of <code>/var/run/__chaosfs__test__/a</code> with the newly opened FD <code>2</code>.</li>
<li>Closes FD <code>2</code>.</li>
</ol>
<p>After the process is finished, FD <code>1</code> of the current process points to <code>/var/run/test/a</code>. So that we can inject faults, any subsequent operations on the target file go through the <a href="https://en.wikipedia.org/wiki/Filesystem_in_Userspace" target="_blank" rel="noopener noreferrer">Filesystem in Userspace</a> (FUSE). FUSE is a software interface for Unix and Unix-like computer operating systems that lets non-privileged users create their own file systems without editing kernel code.</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_xHUa" id="write-a-program-to-make-the-target-process-replace-its-own-file-descriptor">Write a program to make the target process replace its own file descriptor<a href="#write-a-program-to-make-the-target-process-replace-its-own-file-descriptor" class="hash-link" aria-label="Write a program to make the target process replace its own file descriptor的直接链接" title="Write a program to make the target process replace its own file descriptor的直接链接">​</a></h4>
<p>The combined functionality of ptrace and dup2 makes it possible for the tracer to make the tracee replace the opened FD by itself. Now, we need to write a binary program and make the target process run it:</p>
<blockquote>
<p><strong>Note:</strong></p>
<p>In the implementation above, we assume that:</p>
<ul>
<li>The threads of the target process are POSIX threads and share the opened files.</li>
<li>When the target process creates threads using the <code>clone</code> function, the <code>CLONE_FILES</code> parameter is passed.</li>
</ul>
<p>Therefore, Chaos Mesh only replaces the FD of the first thread in the thread group.</p>
</blockquote>
<ol>
<li>Write a piece of assembly code according to the two sections above and the usage of syscall directives. <a href="https://github.com/chaos-mesh/toda/blob/1d73871d8ab72b8d1eace55f5222b01957193531/src/replacer/fd_replacer.rs#L133" target="_blank" rel="noopener noreferrer">Here</a> is an example of the assembly code.</li>
<li>Use an assembler to translate the code into a binary program. We use <a href="https://github.com/CensoredUsername/dynasm-rs" target="_blank" rel="noopener noreferrer">dynasm-rs</a> as the assembler.</li>
<li>Use ptrace to make the target process run this program. When the program runs, the FD is replaced at runtime.</li>
</ol>
<h3 class="anchor anchorWithHideOnScrollNavbar_xHUa" id="overall-fault-injection-process">Overall fault injection process<a href="#overall-fault-injection-process" class="hash-link" aria-label="Overall fault injection process的直接链接" title="Overall fault injection process的直接链接">​</a></h3>
<p>The following diagram illustrates the overall I/O fault injection process:</p>
<p></p><figure><img decoding="async" loading="lazy" alt="Fault injection process" src="/zh/assets/images/fault-injection-process-581a3b4c6954f9ccb3fc9eb17f45f937.jpg" width="1600" height="778" class="img_xWZi"><figcaption class="text--italic text--center" style="color:var(--ifm-color-content-secondary);font-size:0.875rem">Fault injection process</figcaption></figure><p></p>
<div style="margin:1rem 0;font-style:italic;text-align:center"> Fault injection process </div>
<p>In this diagram, each horizontal line corresponds to a thread that runs in the direction of the arrows. The <strong>Mount/Umount Filesystem</strong> and <strong>Replace FD</strong> tasks are carefully arranged in sequence. Given the process above, this arrangement makes a lot of sense.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_xHUa" id="whats-next">What&#x27;s next<a href="#whats-next" class="hash-link" aria-label="What&#x27;s next的直接链接" title="What&#x27;s next的直接链接">​</a></h2>
<p>I&#x27;ve discussed how we implement fault injection to simulate I/O faults at runtime (see <a href="https://github.com/chaos-mesh/toda" target="_blank" rel="noopener noreferrer">chaos-mesh/toda</a>). However, the current implementation is far from perfect:</p>
<ul>
<li>Generation numbers are not supported.</li>
<li>ioctl is not supported.</li>
<li>Chaos Mesh does not immediately determine whether a filesystem is successfully mounted. It does so only after one second.</li>
</ul>
<p>If you are interested in Chaos Mesh and would like to help us improve it, you&#x27;re welcome to join <a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer">our Slack channel</a> or submit your pull requests or issues to our <a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer">GitHub repository</a>.</p>
<p>This is the first post in a series on Chaos Mesh implementation. If you want to see how other types of fault injection are implemented, stay tuned.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>标签：</b><ul class="tags_GlUk padding--none margin-left--sm"><li class="tag_ndSj"><a class="tag_Tyas tagRegular_GbUB" href="/zh/blog/tags/chaos-mesh/">Chaos Mesh</a></li><li class="tag_ndSj"><a class="tag_Tyas tagRegular_GbUB" href="/zh/blog/tags/chaos-engineering/">Chaos Engineering</a></li><li class="tag_ndSj"><a class="tag_Tyas tagRegular_GbUB" href="/zh/blog/tags/fault-injection/">Fault Injection</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/chaos-mesh/website/edit/master/blog/2021-01-08-how-to-simulate-io-faults-at-runtime.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_h6an" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_WwaV"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/blog/celebrating-one-year-of-chaos-mesh-looking-back-and-ahead/"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">Celebrating One Year of Chaos Mesh: Looking Back and Ahead</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/blog/how-a-top-game-company-uses-chaos-engineering-to-improve-testing/"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">How a Top Game Company Uses Chaos Engineering to Improve Testing</div></a></nav></main><div class="col col--2"><div class="tableOfContents_cNUy thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#io-fault-injection" class="table-of-contents__link toc-highlight">I/O fault injection</a></li><li><a href="#inject-io-faults-without-the-mutating-admission-webhook" class="table-of-contents__link toc-highlight">Inject I/O faults without the mutating admission webhook</a><ul><li><a href="#dynamically-replace-file-descriptors" class="table-of-contents__link toc-highlight">Dynamically replace file descriptors</a></li><li><a href="#overall-fault-injection-process" class="table-of-contents__link toc-highlight">Overall fault injection process</a></li></ul></li><li><a href="#whats-next" class="table-of-contents__link toc-highlight">What&#39;s next</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/quick-start/">快速试用</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/run-a-chaos-experiment/">运行实验</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/developer-guide-overview/">开发指南概览</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/faqs/">常见问题</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/blog/">博客</a></li><li class="footer__item"><a href="https://community.cncf.io/chaos-mesh-community/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF 社团<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_WtTX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_WtTX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack (#project-chaos-mesh)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_WtTX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/chaos_mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_WtTX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">致谢</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://storyset.com/technology" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks for the technology illustrations by Storyset<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_WtTX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item">
                <a href="https://www.netlify.com">
                  <img src="https://www.netlify.com/v3/img/components/netlify-color-bg.svg" alt="Deploys by Netlify">
                </a>
              </li><li class="footer__item">
                <img referrerpolicy="no-referrer-when-downgrade" src="https://static.scarf.sh/a.png?x-pxid=3103bfa4-2073-4b9a-bdac-f36f63d979a4">
              </li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <p style="font-weight: 500;">Copyright © Chaos Mesh Authors 2024 | Documentation Distributed under CC-BY-4.0</p>
        © 2024 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.
      </div></div></div></footer></div>
</body>
</html>