<!doctype html>
<html lang="zh" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Chaos Mesh RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Chaos Mesh Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-90760217-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="search" type="application/opensearchdescription+xml" title="Chaos Mesh" href="/zh/opensearch.xml"><title data-rh="true">Simulating Clock Skew in K8s Without Affecting Other Containers on the Node | Chaos Mesh</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chaos-mesh.org/zh/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Simulating Clock Skew in K8s Without Affecting Other Containers on the Node | Chaos Mesh"><meta data-rh="true" name="description" content="Clock synchronization in distributed system"><meta data-rh="true" property="og:description" content="Clock synchronization in distributed system"><meta data-rh="true" property="og:image" content="https://chaos-mesh.org/zh/img/clock-sync-chaos-engineering-k8s.jpg"><meta data-rh="true" name="twitter:image" content="https://chaos-mesh.org/zh/img/clock-sync-chaos-engineering-k8s.jpg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-04-20T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/cwen0"><meta data-rh="true" property="article:tag" content="Chaos Mesh,Chaos Engineering,Kubernetes,Distributed System"><link data-rh="true" rel="icon" href="/zh/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chaos-mesh.org/zh/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/"><link data-rh="true" rel="alternate" href="https://chaos-mesh.org/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" hreflang="en"><link data-rh="true" rel="alternate" href="https://chaos-mesh.org/zh/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" hreflang="zh"><link data-rh="true" rel="alternate" href="https://chaos-mesh.org/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://3BY0S3HQX6-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.a6d06de6.css">
<link rel="preload" href="/zh/assets/js/runtime~main.1244c66b.js" as="script">
<link rel="preload" href="/zh/assets/js/main.7af61b0f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/logos/logo-mini.svg" alt="Chaos Mesh" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh/img/logos/logo-mini-white.svg" alt="Chaos Mesh" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Chaos Mesh</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/zh/docs/">2.3.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/">Next</a></li><li><a class="dropdown__link" href="/zh/docs/">2.3.0</a></li><li><a class="dropdown__link" href="/zh/docs/2.2.3/">2.2.3</a></li><li><a class="dropdown__link" href="/zh/docs/2.1.7/">2.1.7</a></li><li><a class="dropdown__link" href="/zh/docs/2.0.7/">2.0.7</a></li><li><a class="dropdown__link" href="/zh/docs/1.2.4/">1.2.4</a></li><li><a class="dropdown__link" href="/zh/docs/1.1.4/">1.1.4</a></li><li><a class="dropdown__link" href="/zh/docs/1.0.3/">1.0.3</a></li><li><a class="dropdown__link" href="/zh/docs/0.9.1/">0.9.1</a></li></ul></div><a class="navbar__item navbar__link" href="/zh/docs/">文档</a><a class="navbar__item navbar__link" href="/zh/interactive-tutorial/">交互式教程</a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog/">博客</a><a href="https://community.cncf.io/chaos-mesh-community/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/zh/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">简体中文</a></li></ul></div><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">最近的文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/chaos-mesh-qa-at-kubecon-eu-2022/">Chaos Mesh Q&amp;A at KUBECON EU 2022</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/experience-as-a-chaos-mesh-lfx-mentee/">Experience as an LFX Mentee for Chaos Mesh</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/develop-a-daily-reporting-system/">How to Develop a Daily Reporting System to Track Chaos Testing Results</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/share-your-chaos-mesh-story/">Share your #ChaosMeshStory!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh/blog/deploy-chaos-mesh-on-kubesphere/">Deploy Chaos Mesh on KubeSphere</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://chaos-mesh.org/zh/img/clock-sync-chaos-engineering-k8s.jpg"><header><h1 class="title_f1Hy" itemprop="headline">Simulating Clock Skew in K8s Without Affecting Other Containers on the Node</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-04-20T00:00:00.000Z" itemprop="datePublished">2020年4月20日</time> · <!-- -->9 分钟阅读</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/cwen0" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars1.githubusercontent.com/u/22956341?v=4" alt="Cwen Yin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/cwen0" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Cwen Yin</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Chaos Mesh</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="Clock synchronization in distributed system" src="/zh/assets/images/clock-sync-chaos-engineering-k8s-05986b97ada98f9cf1cabda6a8855c86.jpg" width="2000" height="667" class="img_ev3q"></p><p><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer">Chaos Mesh</a>, an easy-to-use, open-source, cloud-native chaos engineering platform for Kubernetes (K8s), has a new feature, TimeChaos, which simulates the <a href="https://en.wikipedia.org/wiki/Clock_skew#On_a_network" target="_blank" rel="noopener noreferrer">clock skew</a> phenomenon. Usually, when we modify clocks in a container, we want a <a href="https://learning.oreilly.com/library/view/chaos-engineering/9781491988459/ch07.html" target="_blank" rel="noopener noreferrer">minimized blast radius</a>, and we don&#x27;t want the change to affect the other containers on the node. In reality, however, implementing this can be harder than you think. How does Chaos Mesh solve this problem?</p><p>In this post, I&#x27;ll describe how we hacked through different approaches of clock skew and how TimeChaos in Chaos Mesh enables time to swing freely in containers.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="simulating-clock-skew-without-affecting-other-containers-on-the-node">Simulating clock skew without affecting other containers on the node<a class="hash-link" href="#simulating-clock-skew-without-affecting-other-containers-on-the-node" title="Direct link to heading">​</a></h2><p>Clock skew refers to the time difference between clocks on nodes within a network. It might cause reliability problems in a distributed system, and it&#x27;s a concern for designers and developers of complex distributed systems. For example, in a distributed SQL database, it&#x27;s vital to maintain a synchronized local clock across nodes to achieve a consistent global snapshot and ensure the ACID properties for transactions.</p><p>Currently, there are well-recognized <a href="https://pingcap.com/blog/Time-in-Distributed-Systems/" target="_blank" rel="noopener noreferrer">solutions to synchronize clocks</a>, but without proper testing, you can never be sure that your implementation is solid.</p><p>Then how can we test global snapshot consistency in a distributed system? The answer is obvious: we can simulate clock skew to test whether distributed systems can keep a consistent global snapshot under abnormal clock conditions. Some testing tools support simulating clock skew in containers, but they have an impact on physical nodes.</p><p><a href="https://github.com/chaos-mesh/chaos-mesh/wiki/Time-Chaos" target="_blank" rel="noopener noreferrer">TimeChaos</a> is a tool that <strong>simulates clock skew in containers to test how it impacts your application without affecting the whole node</strong>. This way, we can precisely identify the potential consequences of clock skew and take measures accordingly.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="various-approaches-for-simulating-clock-skew-weve-explored">Various approaches for simulating clock skew we&#x27;ve explored<a class="hash-link" href="#various-approaches-for-simulating-clock-skew-weve-explored" title="Direct link to heading">​</a></h2><p>Reviewing the existing choices, we know clearly that they cannot be applied to Chaos Mesh, which runs on Kubernetes. Two common ways of simulating clock skew--changing the node clock directly and using the Jepsen framework--change the time for all processes on the node. These are not acceptable solutions for us. In a Kubernetes container, if we inject a clock skew error that affects the entire node, other containers on the same node will be disturbed. Such a clumsy approach is not tolerable.</p><p>Then how are we supposed to tackle this problem? Well, the first thing that comes into our mind is finding solutions in the kernel using <a href="https://en.wikipedia.org/wiki/Berkeley_Packet_Filter" target="_blank" rel="noopener noreferrer">Berkeley Packet Filter</a> (BPF).</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ld_preload"><code>LD_PRELOAD</code><a class="hash-link" href="#ld_preload" title="Direct link to heading">​</a></h3><p><code>LD_PRELOAD</code> is a Linux environment variable that lets you define which dynamic link library is loaded before the program execution.</p><p>This variable has two advantages:</p><ul><li>We can call our own functions without being aware of the source code.</li><li>We can inject code into other programs to achieve specific purposes.</li></ul><p>For some languages that use applications to call the time function in glibc, such as Rust and C, using <code>LD_PRELOAD</code> is enough to simulate clock skew. But things are trickier for Golang. Because languages such as Golang directly parse virtual Dynamic Shared Object (<a href="http://man7.org/linux/man-pages/man7/vdso.7.html" target="_blank" rel="noopener noreferrer">vDSO</a>), a mechanism to speed up system calls. To obtain the time function address, we can&#x27;t simply use <code>LD_PRELOAD</code> to intercept the glic interface. Therefore, <code>LD_PRELOAD</code> is not our solution.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="use-bpf-to-modify-the-return-value-of-clock_gettime-system-call">Use BPF to modify the return value of <code>clock_gettime</code> system call<a class="hash-link" href="#use-bpf-to-modify-the-return-value-of-clock_gettime-system-call" title="Direct link to heading">​</a></h3><p>We also tried to filter the task <a href="http://www.linfo.org/pid.html" target="_blank" rel="noopener noreferrer">process identification number</a> (PID) with BPF. This way, we could simulate clock skew on a specified process and modify the return value of the <code>clock_gettime</code> system call.</p><p>This seemed like a good idea, but we also encountered a problem: in most cases, vDSO speeds up <code>clock_gettime</code>, but <code>clock_gettime</code> doesn&#x27;t make a system call. This selection didn&#x27;t work, either. Oops.</p><p>Thankfully, we determined that if the system kernel version is 4.18 or later, and if we use the <a href="https://www.kernel.org/doc/html/latest/timers/hpet.html" target="_blank" rel="noopener noreferrer">HPET</a> clock, <code>clock_gettime()</code> gets time by making normal system calls instead of vDSO. We implemented <a href="https://github.com/chaos-mesh/bpfki" target="_blank" rel="noopener noreferrer">a version of clock skew</a> using this approach, and it works fine for Rust and C. As for Golang, the program can get the time right, but if we perform <code>sleep</code> during the clock skew injection, the sleep operation is very likely to be blocked. Even after the injection is canceled, the system cannot recover. Thus, we have to give up this approach, too.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="timechaos-our-final-hack">TimeChaos, our final hack<a class="hash-link" href="#timechaos-our-final-hack" title="Direct link to heading">​</a></h2><p>From the previous section, we know that programs usually get the system time by calling <code>clock_gettime</code>. In our case, <code>clock_gettime</code> uses vDSO to speed up the calling process, so we cannot use <code>LD_PRELOAD</code> to hack the <code>clock_gettime</code> system calls.</p><p>We figured out the cause; then what&#x27;s the solution? Start from vDSO. If we can redirect the address that stores the <code>clock_gettime</code> return value in vDSO to an address we define, we can solve the problem.</p><p>Easier said than done. To achieve this goal, we must tackle the following problems:</p><ul><li>Know the user-mode address used by vDSO</li><li>Know vDSO&#x27;s kernel-mode address, if we want to modify the <code>clock_gettime</code> function in vDSO by any address in the kernel mode</li><li>Know how to modify vDSO data</li></ul><p>First, we need to peek inside vDSO. We can see the vDSO memory address in <code>/proc/pid/maps</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ cat /proc/pid/maps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">7ffe53143000-7ffe53145000 r-xp 00000000 00:00 0                     [vdso]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The last line is vDSO information. The privilege of this memory space is <code>r-xp</code>: readable and executable, but not writable. That means the user mode cannot modify this memory. We can use <a href="http://man7.org/linux/man-pages/man2/ptrace.2.html" target="_blank" rel="noopener noreferrer">ptrace</a> to avoid this restriction.</p><p>Next, we use <code>gdb dump memory</code> to export the vDSO and use <code>objdump</code> to see what&#x27;s inside. Here is what we get:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(gdb) dump memory vdso.so 0x00007ffe53143000 0x00007ffe53145000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ objdump -T vdso.so</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vdso.so:    file format elf64-x86-64</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">DYNAMIC SYMBOL TABLE:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ffffffffff700600  w  DF .text   0000000000000545  LINUX_2.6  clock_gettime</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see that the whole vDSO is like a <code>.so</code> file, so we can use an executable and linkable format (ELF) file to format it. With this information, a basic workflow for implementing TimeChaos starts to take shape:</p><p><img loading="lazy" alt="TimeChaos workflow" src="/zh/assets/images/timechaos-workflow-b9960dd4ac9c21fa72817ae910305235.jpg" width="965" height="103" class="img_ev3q"></p><div class="caption-center"> TimeChaos workflow </div><p>The chart above is the process of <strong>TimeChaos</strong>, an implementation of clock skew in Chaos Mesh.</p><ol><li>Use ptrace to attach the specified PID process to stop the current process.</li><li>Use ptrace to create a new mapping in the virtual address space of the calling process and use <a href="https://linux.die.net/man/2/process_vm_writev" target="_blank" rel="noopener noreferrer"><code>process_vm_writev</code></a> to write the <code>fake_clock_gettime</code> function we defined into the memory space.</li><li>Use <code>process_vm_writev</code> to write the specified parameters into <code>fake_clock_gettime</code>. These parameters are the time we would like to inject, such as two hours backward or two days forward.</li><li>Use ptrace to modify the <code>clock_gettime</code> function in vDSO and redirect to the <code>fake_clock_gettime</code> function.</li><li>Use ptrace to detach the PID process.</li></ol><p>If you are interested in the details, see the <a href="https://github.com/chaos-mesh/chaos-mesh/blob/master/pkg/time/time_linux.go" target="_blank" rel="noopener noreferrer">Chaos Mesh GitHub repository</a>.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="simulating-clock-skew-on-a-distributed-sql-database">Simulating clock skew on a distributed SQL database<a class="hash-link" href="#simulating-clock-skew-on-a-distributed-sql-database" title="Direct link to heading">​</a></h2><p>Statistics speak volumes. Here we&#x27;re going to try TimeChaos on <a href="https://pingcap.com/docs/stable/overview/" target="_blank" rel="noopener noreferrer">TiDB</a>, an open source, <a href="https://en.wikipedia.org/wiki/NewSQL" target="_blank" rel="noopener noreferrer">NewSQL</a>, distributed SQL database that supports <a href="https://en.wikipedia.org/wiki/Hybrid_transactional/analytical_processing" target="_blank" rel="noopener noreferrer">Hybrid Transactional/Analytical Processing</a> (HTAP) workloads, to see if the chaos testing can really work.</p><p>TiDB uses a centralized service Timestamp Oracle (TSO) to obtain the globally consistent version number, and to ensure that the transaction version number increases monotonically. The TSO service is managed by the Placement Driver (PD) component. Therefore, we choose a random PD node and inject TimeChaos regularly, each with a 10-millisecond-backward clock skew. Let&#x27;s see if TiDB can meet the challenge.</p><p>To better perform the testing, we use <a href="https://github.com/cwen0/bank" target="_blank" rel="noopener noreferrer">bank</a> as the workload, which simulates the financial transfers in a banking system. It&#x27;s often used to verify the correctness of database transactions.</p><p>This is our test configuration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: chaos-mesh.org/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: TimeChaos</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: time-skew-example</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  namespace: tidb-demo</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  mode: one</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    labelSelectors:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;app.kubernetes.io/component&quot;: &quot;pd&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  timeOffset:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sec: -600</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  clockIds:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - CLOCK_REALTIME</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  duration: &quot;10s&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  scheduler:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cron: &quot;@every 1m&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>During this test, Chaos Mesh injects TimeChaos into a chosen PD Pod every 1 millisecond for 10 seconds. Within the duration, the time acquired by PD will have a 600 second offset from the actual time. For further details, see <a href="https://github.com/chaos-mesh/chaos-mesh/wiki/Time-Chaos" target="_blank" rel="noopener noreferrer">Chaos Mesh Wiki</a>.</p><p>Let&#x27;s create a TimeChaos experiment using the <code>kubectl apply</code> command:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl apply -f pd-time.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, we can retrieve the PD log by the following command:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl logs -n tidb-demo tidb-app-pd-0 | grep &quot;system time jump backward&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here&#x27;s the log:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:06:23.164 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585041383060109693]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:16:32.260 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585041992160476622]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:20:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042231960027622]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:23:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042411960079655]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:25:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042531963640321]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:28:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042711960148191]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:33:32.063 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043011960517655]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:34:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043071959942937]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:35:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043131978582964]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:36:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043191960687755]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:38:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043311959970737]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:41:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043491959970502]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:45:32.061 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043731961304629]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>From the log above, we see that every now and then, PD detects that the system time rolls back. This means:</p><ul><li>TimeChaos successfully simulates clock skew.</li><li>PD can deal with the clock skew situation.</li></ul><p>That&#x27;s encouraging. But does TimeChaos affect services other than PD? We can check it out in the Chaos Dashboard:</p><p><img loading="lazy" alt="Chaos Dashboard" src="/zh/assets/images/chaos-dashboard-0693a3b8da68e9c7f47c7c633dbb1f9b.jpg" width="2000" height="1012" class="img_ev3q"></p><div class="caption-center"> Chaos Dashboard </div><p>It&#x27;s clear that in the monitor, TimeChaos was injected every 1 millisecond and the whole duration lasted 10 seconds. What&#x27;s more, TiDB was not affected by that injection. The bank program ran normally, and performance was not affected.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="try-out-chaos-mesh">Try out Chaos Mesh<a class="hash-link" href="#try-out-chaos-mesh" title="Direct link to heading">​</a></h2><p>As a cloud-native chaos engineering platform, Chaos Mesh features all-around <a href="https://pingcap.com/blog/chaos-mesh-your-chaos-engineering-solution-for-system-resiliency-on-kubernetes/" target="_blank" rel="noopener noreferrer">fault injection methods for complex systems on Kubernetes</a>, covering faults in Pods, the network, the file system, and even the kernel.</p><p>Wanna have some hands-on experience in chaos engineering? Welcome to <a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer">Chaos Mesh</a>. This <a href="https://pingcap.com/blog/run-first-chaos-experiment-in-ten-minutes/" target="_blank" rel="noopener noreferrer">10-minute tutorial</a> will help you quickly get started with chaos engineering and run your first chaos experiment with Chaos Mesh.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/chaos-mesh/">Chaos Mesh</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/chaos-engineering/">Chaos Engineering</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/kubernetes/">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zh/blog/tags/distributed-system/">Distributed System</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/chaos-mesh/website/edit/master/blog/2020-04-20-simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>修改本文</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/blog/chaos-mesh-join-cncf-sandbox-project/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Chaos Mesh Joins CNCF as a Sandbox Project</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/blog/run_your_first_chaos_experiment/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Run Your First Chaos Experiment in 10 Minutes</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#simulating-clock-skew-without-affecting-other-containers-on-the-node" class="table-of-contents__link toc-highlight">Simulating clock skew without affecting other containers on the node</a></li><li><a href="#various-approaches-for-simulating-clock-skew-weve-explored" class="table-of-contents__link toc-highlight">Various approaches for simulating clock skew we&#39;ve explored</a><ul><li><a href="#ld_preload" class="table-of-contents__link toc-highlight"><code>LD_PRELOAD</code></a></li><li><a href="#use-bpf-to-modify-the-return-value-of-clock_gettime-system-call" class="table-of-contents__link toc-highlight">Use BPF to modify the return value of <code>clock_gettime</code> system call</a></li></ul></li><li><a href="#timechaos-our-final-hack" class="table-of-contents__link toc-highlight">TimeChaos, our final hack</a></li><li><a href="#simulating-clock-skew-on-a-distributed-sql-database" class="table-of-contents__link toc-highlight">Simulating clock skew on a distributed SQL database</a></li><li><a href="#try-out-chaos-mesh" class="table-of-contents__link toc-highlight">Try out Chaos Mesh</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/quick-start/">快速试用（测试推荐）</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/run-a-chaos-experiment/">运行实验</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/developer-guide-overview/">开发指南概览</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/faqs/">FAQs</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/chaos_mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack (#project-chaos-mesh)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://community.cncf.io/chaos-mesh-community/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog/">博客</a></li></ul></div><div class="col footer__col"><div class="footer__title">其他</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.netlify.com"><img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>© Chaos Mesh Authors 2021 | Documentation Distributed under CC-BY-4.0 </strong>
        <br>
        <br>
        © 2021 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.
      </div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.1244c66b.js"></script>
<script src="/zh/assets/js/main.7af61b0f.js"></script>
</body>
</html>