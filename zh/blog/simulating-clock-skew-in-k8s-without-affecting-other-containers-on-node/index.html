<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Chaos Mesh Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Chaos Mesh Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-90760217-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Chaos Mesh" href="/zh/opensearch.xml"><title data-react-helmet="true">Simulating Clock Skew in K8s Without Affecting Other Containers on the Node | Chaos Mesh</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://chaos-mesh.org/zh/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Simulating Clock Skew in K8s Without Affecting Other Containers on the Node | Chaos Mesh"><meta data-react-helmet="true" name="description" content="Clock synchronization in distributed system"><meta data-react-helmet="true" property="og:description" content="Clock synchronization in distributed system"><meta data-react-helmet="true" property="og:image" content="https://chaos-mesh.org/zh/img/clock-sync-chaos-engineering-k8s.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://chaos-mesh.org/zh/img/clock-sync-chaos-engineering-k8s.jpg"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2020-04-20T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/cwen0"><meta data-react-helmet="true" property="article:tag" content="Chaos Mesh,Chaos Engineering,Kubernetes,Distributed System"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://chaos-mesh.org/zh/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/"><link data-react-helmet="true" rel="alternate" href="https://chaos-mesh.org/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://chaos-mesh.org/zh/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://chaos-mesh.org/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.50757113.css">
<link rel="preload" href="/zh/assets/js/runtime~main.28638aa6.js" as="script">
<link rel="preload" href="/zh/assets/js/main.fe6db942.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#37b5fb" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">Chaos Mesh 2.0 was released in July, 2021, see <a href="/blog/chaos-mesh-2.0-to-a-chaos-engineering-ecology">what's new</a>!</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logos/logo-mini.svg" alt="Chaos Mesh" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh/img/logos/logo-mini-white.svg" alt="Chaos Mesh" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Chaos Mesh</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/zh/docs/">2.0.5</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/">Next</a></li><li><a class="dropdown__link" href="/zh/docs/">2.0.5</a></li><li><a class="dropdown__link" href="/zh/docs/1.2.4/">1.2.4</a></li><li><a class="dropdown__link" href="/zh/docs/1.1.4/">1.1.4</a></li><li><a class="dropdown__link" href="/zh/docs/1.0.3/">1.0.3</a></li><li><a class="dropdown__link" href="/zh/docs/0.9.1/">0.9.1</a></li></ul></div><a class="navbar__item navbar__link" href="/zh/docs/">ÊñáÊ°£</a><a class="navbar__item navbar__link" href="/zh/interactive-tutorial/">‰∫§‰∫íÂºèÊïôÁ®ã</a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog/">ÂçöÂÆ¢</a><a href="https://community.cncf.io/chaos-mesh-community/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_3vod"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>ÁÆÄ‰Ωì‰∏≠Êñá</span></span></a><ul class="dropdown__menu"><li><a href="/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub"></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="ÊêúÁ¥¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">ÊêúÁ¥¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">ÊúÄËøëÁöÑÊñáÁ´†</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/chaos-mesh-hacktoberfest-2021/">Hacktoberfest 2021: hack with Chaos Mesh!</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/run-chaos-experiments-on-physical-machines/">How to run chaos experiments on your physical machine</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/Securing-Online-Gaming-Combine-Chaos-Engineering-with-DevOps-Practices/">Securing Online Gaming: Combine Chaos Engineering with DevOps Practices</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/How-Chaos-Mesh-Helps-Apache-APISIX-Improve-System-Stability/">How Chaos Mesh Helps Apache APISIX Improve System Stability</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/chaos-mesh-2.0-to-a-chaos-engineering-ecology/">Chaos Mesh 2.0: To a Chaos Engineering Ecology</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Simulating Clock Skew in K8s Without Affecting Other Containers on the Node</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2020-04-20T00:00:00.000Z" itemprop="datePublished">April 20, 2020</time> ¬∑ One min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/cwen0" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://avatars1.githubusercontent.com/u/22956341?v=4" alt="Cwen Yin"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/cwen0" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Cwen Yin</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Chaos Mesh</small></div></div></div></div></header><meta itemprop="image" content="https://chaos-mesh.org/zh/img/clock-sync-chaos-engineering-k8s.jpg"><div class="markdown" itemprop="articleBody"><p><img alt="Clock synchronization in distributed system" src="/zh/assets/images/clock-sync-chaos-engineering-k8s-05986b97ada98f9cf1cabda6a8855c86.jpg"></p><p><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer">Chaos Mesh‚Ñ¢</a>, an easy-to-use, open-source, cloud-native chaos engineering platform for Kubernetes (K8s), has a new feature, TimeChaos, which simulates the <a href="https://en.wikipedia.org/wiki/Clock_skew#On_a_network" target="_blank" rel="noopener noreferrer">clock skew</a> phenomenon. Usually, when we modify clocks in a container, we want a <a href="https://learning.oreilly.com/library/view/chaos-engineering/9781491988459/ch07.html" target="_blank" rel="noopener noreferrer">minimized blast radius</a>, and we don&#x27;t want the change to affect the other containers on the node. In reality, however, implementing this can be harder than you think. How does Chaos Mesh solve this problem?</p><p>In this post, I&#x27;ll describe how we hacked through different approaches of clock skew and how TimeChaos in Chaos Mesh enables time to swing freely in containers.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="simulating-clock-skew-without-affecting-other-containers-on-the-node"></a>Simulating clock skew without affecting other containers on the node<a class="hash-link" href="#simulating-clock-skew-without-affecting-other-containers-on-the-node" title="Direct link to heading">#</a></h2><p>Clock skew refers to the time difference between clocks on nodes within a network. It might cause reliability problems in a distributed system, and it&#x27;s a concern for designers and developers of complex distributed systems. For example, in a distributed SQL database, it&#x27;s vital to maintain a synchronized local clock across nodes to achieve a consistent global snapshot and ensure the ACID properties for transactions.</p><p>Currently, there are well-recognized <a href="https://pingcap.com/blog/Time-in-Distributed-Systems/" target="_blank" rel="noopener noreferrer">solutions to synchronize clocks</a>, but without proper testing, you can never be sure that your implementation is solid.</p><p>Then how can we test global snapshot consistency in a distributed system? The answer is obvious: we can simulate clock skew to test whether distributed systems can keep a consistent global snapshot under abnormal clock conditions. Some testing tools support simulating clock skew in containers, but they have an impact on physical nodes.</p><p><a href="https://github.com/chaos-mesh/chaos-mesh/wiki/Time-Chaos" target="_blank" rel="noopener noreferrer">TimeChaos</a> is a tool that <strong>simulates clock skew in containers to test how it impacts your application without affecting the whole node</strong>. This way, we can precisely identify the potential consequences of clock skew and take measures accordingly.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="various-approaches-for-simulating-clock-skew-weve-explored"></a>Various approaches for simulating clock skew we&#x27;ve explored<a class="hash-link" href="#various-approaches-for-simulating-clock-skew-weve-explored" title="Direct link to heading">#</a></h2><p>Reviewing the existing choices, we know clearly that they cannot be applied to Chaos Mesh, which runs on Kubernetes. Two common ways of simulating clock skew--changing the node clock directly and using the Jepsen framework--change the time for all processes on the node. These are not acceptable solutions for us. In a Kubernetes container, if we inject a clock skew error that affects the entire node, other containers on the same node will be disturbed. Such a clumsy approach is not tolerable.</p><p>Then how are we supposed to tackle this problem? Well, the first thing that comes into our mind is finding solutions in the kernel using <a href="https://en.wikipedia.org/wiki/Berkeley_Packet_Filter" target="_blank" rel="noopener noreferrer">Berkeley Packet Filter</a> (BPF).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="ld_preload"></a><code>LD_PRELOAD</code><a class="hash-link" href="#ld_preload" title="Direct link to heading">#</a></h3><p><code>LD_PRELOAD</code> is a Linux environment variable that lets you define which dynamic link library is loaded before the program execution.</p><p>This variable has two advantages:</p><ul><li>We can call our own functions without being aware of the source code.</li><li>We can inject code into other programs to achieve specific purposes.</li></ul><p>For some languages that use applications to call the time function in glibc, such as Rust and C, using <code>LD_PRELOAD</code> is enough to simulate clock skew. But things are trickier for Golang. Because languages such as Golang directly parse virtual Dynamic Shared Object (<a href="http://man7.org/linux/man-pages/man7/vdso.7.html" target="_blank" rel="noopener noreferrer">vDSO</a>), a mechanism to speed up system calls. To obtain the time function address, we can&#x27;t simply use <code>LD_PRELOAD</code> to intercept the glic interface. Therefore, <code>LD_PRELOAD</code> is not our solution.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="use-bpf-to-modify-the-return-value-of-clock_gettime-system-call"></a>Use BPF to modify the return value of <code>clock_gettime</code> system call<a class="hash-link" href="#use-bpf-to-modify-the-return-value-of-clock_gettime-system-call" title="Direct link to heading">#</a></h3><p>We also tried to filter the task <a href="http://www.linfo.org/pid.html" target="_blank" rel="noopener noreferrer">process identification number</a> (PID) with BPF. This way, we could simulate clock skew on a specified process and modify the return value of the <code>clock_gettime</code> system call.</p><p>This seemed like a good idea, but we also encountered a problem: in most cases, vDSO speeds up <code>clock_gettime</code>, but <code>clock_gettime</code> doesn&#x27;t make a system call. This selection didn&#x27;t work, either. Oops.</p><p>Thankfully, we determined that if the system kernel version is 4.18 or later, and if we use the <a href="https://www.kernel.org/doc/html/latest/timers/hpet.html" target="_blank" rel="noopener noreferrer">HPET</a> clock, <code>clock_gettime()</code> gets time by making normal system calls instead of vDSO. We implemented <a href="https://github.com/chaos-mesh/bpfki" target="_blank" rel="noopener noreferrer">a version of clock skew</a> using this approach, and it works fine for Rust and C. As for Golang, the program can get the time right, but if we perform <code>sleep</code> during the clock skew injection, the sleep operation is very likely to be blocked. Even after the injection is canceled, the system cannot recover. Thus, we have to give up this approach, too.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="timechaos-our-final-hack"></a>TimeChaos, our final hack<a class="hash-link" href="#timechaos-our-final-hack" title="Direct link to heading">#</a></h2><p>From the previous section, we know that programs usually get the system time by calling <code>clock_gettime</code>. In our case, <code>clock_gettime</code> uses vDSO to speed up the calling process, so we cannot use <code>LD_PRELOAD</code> to hack the <code>clock_gettime</code> system calls.</p><p>We figured out the cause; then what&#x27;s the solution? Start from vDSO. If we can redirect the address that stores the <code>clock_gettime</code> return value in vDSO to an address we define, we can solve the problem.</p><p>Easier said than done. To achieve this goal, we must tackle the following problems:</p><ul><li>Know the user-mode address used by vDSO</li><li>Know vDSO&#x27;s kernel-mode address, if we want to modify the <code>clock_gettime</code> function in vDSO by any address in the kernel mode</li><li>Know how to modify vDSO data</li></ul><p>First, we need to peek inside vDSO. We can see the vDSO memory address in <code>/proc/pid/maps</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ cat /proc/pid/maps</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">7ffe53143000-7ffe53145000 r-xp 00000000 00:00 0                     [vdso]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Â§çÂà∂</button></div></div><p>The last line is vDSO information. The privilege of this memory space is <code>r-xp</code>: readable and executable, but not writable. That means the user mode cannot modify this memory. We can use <a href="http://man7.org/linux/man-pages/man2/ptrace.2.html" target="_blank" rel="noopener noreferrer">ptrace</a> to avoid this restriction.</p><p>Next, we use <code>gdb dump memory</code> to export the vDSO and use <code>objdump</code> to see what&#x27;s inside. Here is what we get:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(gdb) dump memory vdso.so 0x00007ffe53143000 0x00007ffe53145000</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ objdump -T vdso.so</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vdso.so:    file format elf64-x86-64</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">DYNAMIC SYMBOL TABLE:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ffffffffff700600  w  DF .text   0000000000000545  LINUX_2.6  clock_gettime</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Â§çÂà∂</button></div></div><p>We can see that the whole vDSO is like a <code>.so</code> file, so we can use an executable and linkable format (ELF) file to format it. With this information, a basic workflow for implementing TimeChaos starts to take shape:</p><p><img alt="TimeChaos workflow" src="/zh/assets/images/timechaos-workflow-b9960dd4ac9c21fa72817ae910305235.jpg"></p><div class="caption-center"> TimeChaos workflow </div><p>The chart above is the process of <strong>TimeChaos</strong>, an implementation of clock skew in Chaos Mesh.</p><ol><li>Use ptrace to attach the specified PID process to stop the current process.</li><li>Use ptrace to create a new mapping in the virtual address space of the calling process and use <a href="https://linux.die.net/man/2/process_vm_writev" target="_blank" rel="noopener noreferrer"><code>process_vm_writev</code></a> to write the <code>fake_clock_gettime</code> function we defined into the memory space.</li><li>Use <code>process_vm_writev</code> to write the specified parameters into <code>fake_clock_gettime</code>. These parameters are the time we would like to inject, such as two hours backward or two days forward.</li><li>Use ptrace to modify the <code>clock_gettime</code> function in vDSO and redirect to the <code>fake_clock_gettime</code> function.</li><li>Use ptrace to detach the PID process.</li></ol><p>If you are interested in the details, see the <a href="https://github.com/chaos-mesh/chaos-mesh/blob/master/pkg/time/time_linux.go" target="_blank" rel="noopener noreferrer">Chaos Mesh GitHub repository</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="simulating-clock-skew-on-a-distributed-sql-database"></a>Simulating clock skew on a distributed SQL database<a class="hash-link" href="#simulating-clock-skew-on-a-distributed-sql-database" title="Direct link to heading">#</a></h2><p>Statistics speak volumes. Here we&#x27;re going to try TimeChaos on <a href="https://pingcap.com/docs/stable/overview/" target="_blank" rel="noopener noreferrer">TiDB</a>, an open source, <a href="https://en.wikipedia.org/wiki/NewSQL" target="_blank" rel="noopener noreferrer">NewSQL</a>, distributed SQL database that supports <a href="https://en.wikipedia.org/wiki/Hybrid_transactional/analytical_processing" target="_blank" rel="noopener noreferrer">Hybrid Transactional/Analytical Processing</a> (HTAP) workloads, to see if the chaos testing can really work.</p><p>TiDB uses a centralized service Timestamp Oracle (TSO) to obtain the globally consistent version number, and to ensure that the transaction version number increases monotonically. The TSO service is managed by the Placement Driver (PD) component. Therefore, we choose a random PD node and inject TimeChaos regularly, each with a 10-millisecond-backward clock skew. Let&#x27;s see if TiDB can meet the challenge.</p><p>To better perform the testing, we use <a href="https://github.com/cwen0/bank" target="_blank" rel="noopener noreferrer">bank</a> as the workload, which simulates the financial transfers in a banking system. It&#x27;s often used to verify the correctness of database transactions.</p><p>This is our test configuration:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: chaos-mesh.org/v1alpha1</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: TimeChaos</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: time-skew-example</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  namespace: tidb-demo</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  mode: one</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  selector:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    labelSelectors:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;app.kubernetes.io/component&quot;: &quot;pd&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  timeOffset:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sec: -600</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  clockIds:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - CLOCK_REALTIME</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  duration: &quot;10s&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  scheduler:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cron: &quot;@every 1m&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Â§çÂà∂</button></div></div><p>During this test, Chaos Mesh injects TimeChaos into a chosen PD Pod every 1 millisecond for 10 seconds. Within the duration, the time acquired by PD will have a 600 second offset from the actual time. For further details, see <a href="https://github.com/chaos-mesh/chaos-mesh/wiki/Time-Chaos" target="_blank" rel="noopener noreferrer">Chaos Mesh Wiki</a>.</p><p>Let&#x27;s create a TimeChaos experiment using the <code>kubectl apply</code> command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl apply -f pd-time.yaml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Â§çÂà∂</button></div></div><p>Now, we can retrieve the PD log by the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl logs -n tidb-demo tidb-app-pd-0 | grep &quot;system time jump backward&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Â§çÂà∂</button></div></div><p>Here&#x27;s the log:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:06:23.164 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585041383060109693]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:16:32.260 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585041992160476622]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:20:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042231960027622]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:23:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042411960079655]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:25:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042531963640321]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:28:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585042711960148191]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:33:32.063 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043011960517655]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:34:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043071959942937]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:35:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043131978582964]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:36:32.059 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043191960687755]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:38:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043311959970737]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:41:32.060 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043491959970502]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[2020/03/24 09:45:32.061 +00:00] [ERROR] [systime_mon.go:32] [&quot;system time jump backward&quot;] [last=1585043731961304629]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Â§çÂà∂</button></div></div><p>From the log above, we see that every now and then, PD detects that the system time rolls back. This means:</p><ul><li>TimeChaos successfully simulates clock skew.</li><li>PD can deal with the clock skew situation.</li></ul><p>That&#x27;s encouraging. But does TimeChaos affect services other than PD? We can check it out in the Chaos Dashboard:</p><p><img alt="Chaos Dashboard" src="/zh/assets/images/chaos-dashboard-0693a3b8da68e9c7f47c7c633dbb1f9b.jpg"></p><div class="caption-center"> Chaos Dashboard </div><p>It&#x27;s clear that in the monitor, TimeChaos was injected every 1 millisecond and the whole duration lasted 10 seconds. What&#x27;s more, TiDB was not affected by that injection. The bank program ran normally, and performance was not affected.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="try-out-chaos-mesh"></a>Try out Chaos Mesh<a class="hash-link" href="#try-out-chaos-mesh" title="Direct link to heading">#</a></h2><p>As a cloud-native chaos engineering platform, Chaos Mesh features all-around <a href="https://pingcap.com/blog/chaos-mesh-your-chaos-engineering-solution-for-system-resiliency-on-kubernetes/" target="_blank" rel="noopener noreferrer">fault injection methods for complex systems on Kubernetes</a>, covering faults in Pods, the network, the file system, and even the kernel.</p><p>Wanna have some hands-on experience in chaos engineering? Welcome to <a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer">Chaos Mesh</a>. This <a href="https://pingcap.com/blog/run-first-chaos-experiment-in-ten-minutes/" target="_blank" rel="noopener noreferrer">10-minute tutorial</a> will help you quickly get started with chaos engineering and run your first chaos experiment with Chaos Mesh.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zh/blog/tags/chaos-mesh/">Chaos Mesh</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zh/blog/tags/chaos-engineering/">Chaos Engineering</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zh/blog/tags/kubernetes/">Kubernetes</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zh/blog/tags/distributed-system/">Distributed System</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/chaos-mesh/website/edit/master/blog/2020-04-20-simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>‰øÆÊîπÊú¨Êñá</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog/chaos-mesh-join-cncf-sandbox-project/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">¬´ Chaos Mesh Joins CNCF as a Sandbox Project</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/run_your_first_chaos_experiment/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Run Your First Chaos Experiment in 10 Minutes ¬ª</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#simulating-clock-skew-without-affecting-other-containers-on-the-node" class="table-of-contents__link">Simulating clock skew without affecting other containers on the node</a></li><li><a href="#various-approaches-for-simulating-clock-skew-weve-explored" class="table-of-contents__link">Various approaches for simulating clock skew we&#39;ve explored</a><ul><li><a href="#ld_preload" class="table-of-contents__link"><code>LD_PRELOAD</code></a></li><li><a href="#use-bpf-to-modify-the-return-value-of-clock_gettime-system-call" class="table-of-contents__link">Use BPF to modify the return value of <code>clock_gettime</code> system call</a></li></ul></li><li><a href="#timechaos-our-final-hack" class="table-of-contents__link">TimeChaos, our final hack</a></li><li><a href="#simulating-clock-skew-on-a-distributed-sql-database" class="table-of-contents__link">Simulating clock skew on a distributed SQL database</a></li><li><a href="#try-out-chaos-mesh" class="table-of-contents__link">Try out Chaos Mesh</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ÊñáÊ°£</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/quick-start/">Âø´ÈÄüËØïÁî®ÔºàÊµãËØïÊé®ËçêÔºâ</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/run-a-chaos-experiment/">ËøêË°åÂÆûÈ™å</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/developer-guide-overview/">ÂºÄÂèëÊåáÂçóÊ¶ÇËßà</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/faqs/">FAQs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Á§æÂå∫</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/chaos_mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack (#project-chaos-mesh)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://community.cncf.io/chaos-mesh-community/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Êõ¥Â§ö</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog/">ÂçöÂÆ¢</a></li></ul></div><div class="col footer__col"><div class="footer__title">ÂÖ∂‰ªñ</div><ul class="footer__items"><li class="footer__item"><a href="https://www.netlify.com"><img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>¬© Chaos Mesh Authors 2021 | Documentation Distributed under CC-BY-4.0 </strong>
        <br>
        <br>
        ¬© 2021 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.
      </div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.28638aa6.js"></script>
<script src="/zh/assets/js/main.fe6db942.js"></script>
</body>
</html>