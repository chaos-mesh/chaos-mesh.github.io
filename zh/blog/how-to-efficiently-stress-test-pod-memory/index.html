<!doctype html>
<html lang="zh" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">How to efficiently stress test Pod memory | Chaos Mesh</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chaos-mesh.org/zh/blog/how-to-efficiently-stress-test-pod-memory/"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="How to efficiently stress test Pod memory | Chaos Mesh"><meta data-rh="true" name="description" content="banner"><meta data-rh="true" property="og:description" content="banner"><meta data-rh="true" property="og:image" content="https://chaos-mesh.org/zh/img/blog/how-to-efficiently-stress-test-pod-memory-banner.jpg"><meta data-rh="true" name="twitter:image" content="https://chaos-mesh.org/zh/img/blog/how-to-efficiently-stress-test-pod-memory-banner.jpg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-07-01T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/AsterNighT"><meta data-rh="true" property="article:tag" content="Chaos Mesh,Chaos Engineering,StressChaos,Stress Testing"><link data-rh="true" rel="icon" href="/zh/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chaos-mesh.org/zh/blog/how-to-efficiently-stress-test-pod-memory/"><link data-rh="true" rel="alternate" href="https://chaos-mesh.org/blog/how-to-efficiently-stress-test-pod-memory/" hreflang="en"><link data-rh="true" rel="alternate" href="https://chaos-mesh.org/zh/blog/how-to-efficiently-stress-test-pod-memory/" hreflang="zh"><link data-rh="true" rel="alternate" href="https://chaos-mesh.org/blog/how-to-efficiently-stress-test-pod-memory/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://3BY0S3HQX6-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Chaos Mesh RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Chaos Mesh Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-90760217-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="search" type="application/opensearchdescription+xml" title="Chaos Mesh" href="/zh/opensearch.xml"><link rel="stylesheet" href="/zh/assets/css/styles.7ff201cf.css">
<link rel="preload" href="/zh/assets/js/runtime~main.2b51fdf5.js" as="script">
<link rel="preload" href="/zh/assets/js/main.af6f94e2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_urkK" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_gKCh"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/logos/logo-mini.svg" alt="Chaos Mesh" class="themedImage_dqhE themedImage--light_pG96"><img src="/zh/img/logos/logo-mini-white.svg" alt="Chaos Mesh" class="themedImage_dqhE themedImage--dark_RvBr"></div><b class="navbar__title text--truncate">Chaos Mesh</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/zh/docs/">2.6.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/">Next</a></li><li><a class="dropdown__link" href="/zh/docs/">2.6.0</a></li><li><a class="dropdown__link" href="/zh/docs/2.5.2/">2.5.2</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.3/">2.4.3</a></li><li><hr style="margin: .5em 0;"></li><li><a class="dropdown__link" href="/zh/versions/">All Versions</a></li><li><a class="dropdown__link" href="/zh/supported-releases/">Supported Releases</a></li></ul></div><a class="navbar__item navbar__link" href="/zh/docs/">文档</a><a href="https://community.cncf.io/chaos-mesh-community/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">活动<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_OmM5"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog/">博客</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_RVbG"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/blog/how-to-efficiently-stress-test-pod-memory/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh/blog/how-to-efficiently-stress-test-pod-memory/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">简体中文</a></li></ul></div><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub"></a><div class="toggle_CBoD colorModeToggle_U4Ms"><button class="clean-btn toggleButton_Qywp toggleButtonDisabled_sUWV" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_uNXX"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_NcA8"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_oPT5"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_vGGt"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_KXxU thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_ycaT margin-bottom--md">最近的文章</div><ul class="sidebarItemList_uYfz clean-list"><li class="sidebarItem_cAtR"><a class="sidebarItemLink_rhtS" href="/zh/blog/chaos-mesh-qa-at-kubecon-eu-2022/">Chaos Mesh Q&amp;A at KUBECON EU 2022</a></li><li class="sidebarItem_cAtR"><a class="sidebarItemLink_rhtS" href="/zh/blog/experience-as-a-chaos-mesh-lfx-mentee/">Experience as an LFX Mentee for Chaos Mesh</a></li><li class="sidebarItem_cAtR"><a class="sidebarItemLink_rhtS" href="/zh/blog/develop-a-daily-reporting-system/">How to Develop a Daily Reporting System to Track Chaos Testing Results</a></li><li class="sidebarItem_cAtR"><a class="sidebarItemLink_rhtS" href="/zh/blog/share-your-chaos-mesh-story/">Share your #ChaosMeshStory!</a></li><li class="sidebarItem_cAtR"><a class="sidebarItemLink_rhtS" href="/zh/blog/deploy-chaos-mesh-on-kubesphere/">Deploy Chaos Mesh on KubeSphere</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://chaos-mesh.org/zh/img/blog/how-to-efficiently-stress-test-pod-memory-banner.jpg"><header><h1 class="title_xn6M" itemprop="headline">How to efficiently stress test Pod memory</h1><div class="container_dXYV margin-vert--md"><time datetime="2021-07-01T00:00:00.000Z" itemprop="datePublished">2021年7月1日</time> · <!-- -->11 分钟阅读</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_jqgM"><div class="avatar margin-bottom--sm"><a href="https://github.com/AsterNighT" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/22937027?v=4" alt="Yinghao Wang"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/AsterNighT" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Yinghao Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Contributor of Chaos Mesh</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="banner" src="/zh/assets/images/how-to-efficiently-stress-test-pod-memory-banner-3dd86c1ed5645a75c8cd7c2236a7c41a.jpg" width="1600" height="534" class="img_t5GP"></p><p><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer">Chaos Mesh</a> includes the StressChaos tool, which allows you to inject CPU and memory stress into your Pod. This tool can be very useful when you test or benchmark a CPU-sensitive or memory-sensitive program and want to know its behavior under pressure.</p><p>However, as we tested and used StressChaos, we found some issues with usability and performance. For example, why does StressChaos use far less memory than we configured? To correct these issues, we developed a new set of tests. In this article, I&#x27;ll describe how we troubleshooted these issues and corrected them. This information will enable you to get the most out of StressChaos.</p><p>Before you continue, you need to install Chaos Mesh in your cluster. You can find detailed instructions on our <a href="https://chaos-mesh.org/docs/quick-start" target="_blank" rel="noopener noreferrer">website</a>.</p><h2 class="anchor anchorWithHideOnScrollNavbar_dOSS" id="injecting-stress-into-a-target">Injecting stress into a target<a href="#injecting-stress-into-a-target" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>I’d like to demonstrate how to inject StressChaos into a target. In this example, I’ll use <a href="https://github.com/paulbouwer/hello-kubernetes" target="_blank" rel="noopener noreferrer"><code>hello-kubernetes</code></a>, which is managed by <a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">helm charts</a>. The first step is to clone the <a href="https://github.com/paulbouwer/hello-kubernetes" target="_blank" rel="noopener noreferrer"><code>hello-kubernetes</code></a> repo and modify the chart to give it a resource limit.</p><div class="language-bash codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-bash codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">git</span><span class="token plain"> clone https://github.com/paulbouwer/hello-kubernetes.git</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">code deploy/helm/hello-kubernetes/values.yaml </span><span class="token comment" style="color:rgb(98, 114, 164)"># or whichever editor you prefer</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Find the resources line, and change it into:</p><div class="language-yaml codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-yaml codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">requests</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;200Mi&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;500Mi&#x27;</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, before we inject anything, let&#x27;s see how much memory the target is consuming. Go into the Pod and start a shell. Enter the following, substituting the name of your Pod for the one in the example:</p><div class="language-bash codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-bash codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> -it -n hello-kubernetes hello-kubernetes-hello-world-b55bfcf68-8mln6 -- /bin/sh</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Display a summary of memory usage. Enter:</p><div class="language-sh codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-sh codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/src/app $ free -m</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/src/app $ top</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see from the output below, the Pod is consuming 4,269 MB of memory.</p><div class="language-sh codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-sh codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/src/app $ free -m</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              used</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Mem:          4269</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Swap:            0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/src/app $ top</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Mem: 12742432K used</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    1     0 node     S     285m   2%   0   0% npm start</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   18     1 node     S     284m   2%   3   0% node server.js</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   29     0 node     S     1636   0%   2   0% /bin/sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   36    29 node     R     1568   0%   3   0% top</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That doesn’t seem right. We’ve limited its memory usage to 500 MiBs, and now the Pod seems to be using several GBs of memory. If we total the amount of process memory being used, it doesn’t equal 500 MiB. However, top and free at least give similar answers.</p><p>We will run a StressChaos on the Pod and see what happens. Here&#x27;s the yaml we’ll use:</p><div class="language-yaml codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-yaml codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> chaos</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">mesh.org/v1alpha1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> StressChaos</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mem</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">stress</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> chaos</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">mesh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">mode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">namespaces</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">kubernetes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">stressors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">memory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">workers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 50MiB</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">duration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;1h&#x27;</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Save the yaml to a file. I named it <code>memory.yaml</code>. To apply the chaos, run</p><div class="language-bash codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-bash codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">~ kubectl apply -f memory.yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">stresschaos.chaos-mesh.org/mem-stress created</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, let&#x27;s check the memory usage again.</p><div class="language-sh codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-sh codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">              used</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Mem:          4332</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Swap:            0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Mem: 12805568K used</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   54    50 root     R    53252   0%   1  24% {stress-ng-vm} stress-ng --vm 4 --vm-keep --vm-bytes 50000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   57    52 root     R    53252   0%   0  22% {stress-ng-vm} stress-ng --vm 4 --vm-keep --vm-bytes 50000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   55    53 root     R    53252   0%   2  21% {stress-ng-vm} stress-ng --vm 4 --vm-keep --vm-bytes 50000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   56    51 root     R    53252   0%   3  21% {stress-ng-vm} stress-ng --vm 4 --vm-keep --vm-bytes 50000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   18     1 node     S     289m   2%   2   0% node server.js</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    1     0 node     S     285m   2%   0   0% npm start</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   51    49 root     S    41048   0%   0   0% {stress-ng-vm} stress-ng --vm 4 --vm-keep --vm-bytes 50000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   50    49 root     S    41048   0%   2   0% {stress-ng-vm} stress-ng --vm 4 --vm-keep --vm-bytes 50000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   52    49 root     S    41048   0%   0   0% {stress-ng-vm} stress-ng --vm 4 --vm-keep --vm-bytes 50000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   53    49 root     S    41048   0%   3   0% {stress-ng-vm} stress-ng --vm 4 --vm-keep --vm-bytes 50000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   49     0 root     S    41044   0%   0   0% stress-ng --vm 4 --vm-keep --vm-bytes 50000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   29     0 node     S     1636   0%   3   0% /bin/sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   48    29 node     R     1568   0%   1   0% top</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can see that stress-ng instances are being injected into the Pod. There is a 60 MiB rise in the Pod, which we didn’t expect. The <a href="https://manpages.ubuntu.com/manpages/focal/en/man1/stress-ng.1.html" target="_blank" rel="noopener noreferrer">documentation</a> indicates that the increase should 200 MiB (4 <!-- -->*<!-- --> 50 MiB).</p><p>Let&#x27;s increase the stress by changing the memory stress from 50 MiB to 3,000 MiB. This should break the Pod’s memory limit. I’ll delete the chaos, modify the size, and reapply it.</p><p>And then, boom! The shell exits with code 137. A moment later, I reconnect to the container, and the memory usage returns to normal. No stress-ng instances are found! What happened?</p><h2 class="anchor anchorWithHideOnScrollNavbar_dOSS" id="why-does-stresschaos-disappear">Why does StressChaos disappear?<a href="#why-does-stresschaos-disappear" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Kubernetes limits your container memory usage through a mechanism named <a href="https://man7.org/linux/man-pages/man7/cgroups.7.html" target="_blank" rel="noopener noreferrer">cgroup</a>. To see the 500 MiB limit in our Pod, go to the container and enter:</p><div class="language-bash codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-bash codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/src/app $ </span><span class="token function" style="color:rgb(80, 250, 123)">cat</span><span class="token plain"> /sys/fs/cgroup/memory/memory.limit_in_bytes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">524288000</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output is displayed in bytes and translates to <code>500 * 1024 * 1024</code>.</p><p>Requests are used only for scheduling where to place the Pod. The Pod does not have a memory limit or request, but it can be seen as the sum of all its containers.</p><p>We&#x27;ve been making a mistake since the very beginning. free and top are not &quot;cgrouped.&quot; They rely on <code>/proc/meminfo</code> (procfs) for data. Unfortunately, <code>/proc/meminfo</code> is old, so old it predates cgroup. It will provide you with <strong>host</strong> memory information instead of your container. Let&#x27;s start from the beginning and see what memory usage we get this time.</p><p>To get the cgrouped memory usage, enter:</p><div class="language-sh codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-sh codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/src/app $ cat /sys/fs/cgroup/memory/memory.usage_in_bytes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">39821312</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Applying the 50 MiB StressChaos, yields the following:</p><div class="language-sh codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-sh codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/src/app $ cat /sys/fs/cgroup/memory/memory.usage_in_bytes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">93577216</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That is about 51 MiB more memory usage than without StressChaos.</p><p>Next, why did our shell exit? Exit code 137 indicates &quot;failure as container received SIGKILL.&quot; That leads us to check the Pod. Pay attention to the Pod state and events.</p><div class="language-bash codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-bash codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">~ kubectl describe pods -n hello-kubernetes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Last State:     Terminated</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      Reason:       Error</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      Exit Code:    </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Events:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Type     Reason     Age                  From               Message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ----     ------     ----                 ----               -------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Warning  Unhealthy  10m </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x4 over 16m</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">    kubelet            Readiness probe failed: Get </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://10.244.1.19:8080/&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> context deadline exceeded </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Client.Timeout exceeded </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> awaiting headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Normal   Killing    10m </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x2 over 16m</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">    kubelet            Container hello-kubernetes failed liveness probe, will be restarted</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The events tell us why the shell crashed. <code>hello-kubernetes</code> has a liveness probe, and when the container memory is reaching the limit, the application starts to fail, and Kubernetes decides to terminate and restart it. When the Pod restarts, StressChaos stops. In that case, you can say that the chaos works fine. It finds vulnerability in your Pod. You could now fix it, and reapply the chaos. Everything seems perfect now—except for one thing. Why do four 50 MiB vm workers result in 51 MiB in total? The answer will not reveal itself unless we go into the stress-ng source code <a href="https://github.com/ColinIanKing/stress-ng/blob/819f7966666dafea5264cf1a2a0939fd344fcf08/stress-vm.c#L2074" target="_blank" rel="noopener noreferrer">here</a> :</p><div class="language-c codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-c codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vm_bytes </span><span class="token operator">/=</span><span class="token plain"> args</span><span class="token operator">-&gt;</span><span class="token plain">num_instances</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Oops! So the document is wrong. The multiple vm workers will take up the total size specified, rather than <code>mmap</code> that much memory per worker. Now, finally, we get an answer for everything. In the following sections, we’ll discuss some other situations involving memory stress.</p><h2 class="anchor anchorWithHideOnScrollNavbar_dOSS" id="what-if-there-was-no-liveness-probe">What if there was no liveness probe?<a href="#what-if-there-was-no-liveness-probe" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Let&#x27;s delete the probes and try again. Find the following lines in <code>deploy/helm/hello-kubernetes/templates/deployment.yaml</code> and delete them.</p><div class="language-yaml codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-yaml codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">livenessProbe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">httpGet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">readinessProbe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">httpGet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After that, upgrade the deployment.</p><p>What is interesting in this scenario is that the memory usage goes up continuously, and then drops sharply; it goes back and forth. What is happening now? Let&#x27;s check the kernel log. Pay attention to the last two lines.</p><div class="language-sh codeBlockContainer_uizA theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_uij_"><pre tabindex="0" class="prism-code language-sh codeBlock_fGaF thin-scrollbar"><code class="codeBlockLines_JmuN"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/usr/src/app $ dmesg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">......</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[189937.362908] [ pid ]   uid  tgid total_vm      rss nr_ptes swapents oom_score_adj name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[189937.363092] [441060]  1000 441060    63955     3791      80     3030           988 node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[189937.363110] [441688]     0 441688   193367     2136     372   181097          1000 stress-ng-vm</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">......</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[189937.363148] Memory cgroup out of memory: Kill process 443160 (stress-ng-vm) score 1272 or sacrifice child</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[189937.363186] Killed process 443160 (stress-ng-vm), UID 0, total-vm:773468kB, anon-rss:152704kB, file-rss:164kB, shmem-rss:0kB</span><br></span></code></pre><div class="buttonGroup_D7ol"><button type="button" aria-label="Copy code to clipboard" title="复制" class="clean-btn"><span class="copyButtonIcons_isze" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_WOVI"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Vt_x"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It’s clear from the output that the <code>stress-ng-vm</code> processes are being killed because there are out of memory (OOM) errors.</p><p>If processes can’t get the memory they want, things get tricky. They are very likely to fail. Rather than wait for processes to crash, it’s better if you kill some of them to get more memory. The OOM killer stops processes by an order and tries to recover the most memory while causing the least trouble. For detailed information on this process, see <a href="https://lwn.net/Articles/391222/" target="_blank" rel="noopener noreferrer">this introduction</a> to OOM killer.</p><p>Looking at the output above, you can see that <code>node</code>, which is our application process that should never be terminated, has an <code>oom_score_adj</code> of 988. That is quite dangerous since it is the process with the highest score to get killed. But there is a simple way to stop the OOM killer from killing a specific process. When you create a Pod, it is assigned a Quality of Service (QoS) class. For detailed information, see <a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/" target="_blank" rel="noopener noreferrer">Configure Quality of Service for Pods</a>.</p><p>Generally, if you create a Pod with precisely-specified resource requests, it is classified as a <code>Guaranteed</code> Pod. OOM killers do not kill containers in a <code>Guaranteed</code> Pod if there are other things to kill. These entities include non-<code>Guaranteed</code> Pods and stress-ng workers. A Pod with no resource requests is marked as <code>BestEffort</code>, and the OOM killer stops it first.</p><p>So that&#x27;s all for the tour. Our suggestion is that <code>free</code> and <code>top</code> should not be used to assess memory in containers. Be careful when you assign resource limits to your Pod and select the right QoS. In the future, we’ll create a more detailed StressChaos document.</p><h2 class="anchor anchorWithHideOnScrollNavbar_dOSS" id="deeper-dive-into-kubernetes-memory-management">Deeper dive into Kubernetes memory management<a href="#deeper-dive-into-kubernetes-memory-management" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>Kubernetes tries to evict Pods that use too much memory (but not more memory than their limits). Kubernetes gets your Pod memory usage from <code>/sys/fs/cgroup/memory/memory.usage_in_bytes</code> and subtracts it by the <code>total_inactive_file</code> line in <code>memory.stat</code>.</p><p>Keep in mind that Kuberenetes <strong>does not</strong> support swap. Even if you have a node with swap enabled, Kubernetes creates containers with <code>swappiness=0</code>, which means swap is eventually disabled. That is mainly for performance concerns.</p><p><code>memory.usage_in_bytes</code> equals <code>resident set</code> plus <code>cache</code>, and <code>total_inactive_file</code> is memory in cache that the OS can retrieve if the memory is running out. <code>memory.usage_in_bytes - total_inactive_file</code> is called <code>working_set</code>. You will get this <code>working_set</code> value by <code>kubectl top pod &lt;your pod&gt; --containers</code>. Kubernetes uses this value to decide whether or not to evict your Pods.</p><p>Kubernetes periodically inspects memory usage. If a container&#x27;s memory usage increases too quickly or the container cannot be evicted, the OOM killer is invoked. Kubernetes has its way of protecting its own process, so it always picks the container. When a container is killed, it may or may not be restarted, depending on your restart policy. If it is killed, when you execute <code>kubectl describe pod &lt;your pod&gt;</code> you will see it is restarted and the reason is <code>OOMKilled</code>.</p><p>Another thing worth mentioning is the kernel memory. Since <code>v1.9</code>, Kubernetes’ kernel memory support is enabled by default. It is also a feature of cgroup memory subsystems. You can limit container kernel memory usage. Unfortunately, this causes a cgroup leak on kernel versions up to <code>v4.2</code>. You can either upgrade your kernel to <code>v4.3</code> or disable it.</p><h2 class="anchor anchorWithHideOnScrollNavbar_dOSS" id="how-we-implement-stresschaos">How we implement StressChaos<a href="#how-we-implement-stresschaos" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>StressChaos is a simple way to test your container&#x27;s behavior when it is low on memory. StressChaos utilizes a powerful tool named <code>stress-ng</code> to allocate memory and continue writing to the allocated memory. Because containers have memory limits and container limits are bound to a cgroup, we must find a way to run <code>stress-ng</code> in a specific cgroup. Luckily, this part is easy. With enough privileges, we can assign any process to any cgroup by writing to files in <code>/sys/fs/cgroup/</code>.</p><p>If you are interested in Chaos Mesh and would like to help us improve it, you&#x27;re welcome to join our <a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer">Slack channel</a> (#project-chaos-mesh)! Or submit your pull requests or issues to our <a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer">GitHub repository</a>.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_nlmr"><div class="col"><b>Tags:</b><ul class="tags_BPaW padding--none margin-left--sm"><li class="tag_jIiW"><a class="tag_v_4J tagRegular_bL5S" href="/zh/blog/tags/chaos-mesh/">Chaos Mesh</a></li><li class="tag_jIiW"><a class="tag_v_4J tagRegular_bL5S" href="/zh/blog/tags/chaos-engineering/">Chaos Engineering</a></li><li class="tag_jIiW"><a class="tag_v_4J tagRegular_bL5S" href="/zh/blog/tags/stress-chaos/">StressChaos</a></li><li class="tag_jIiW"><a class="tag_v_4J tagRegular_bL5S" href="/zh/blog/tags/stress-testing/">Stress Testing</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/chaos-mesh/website/edit/master/blog/2021-07-01-how-to-efficiently-stress-test-pod-memory.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_A8kI" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>修改本文</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/blog/securing-tenant-namespaces-using-restrict-authorization-feature/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Securing tenant namespaces using restrict authorization feature in Chaos Mesh</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/blog/chaos-mesh-remake-one-step-closer-towards-chaos-as-a-service/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Chaos Mesh Remake: One Step Closer toward Chaos as a Service</div></a></nav></main><div class="col col--2"><div class="tableOfContents_C37A thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#injecting-stress-into-a-target" class="table-of-contents__link toc-highlight">Injecting stress into a target</a></li><li><a href="#why-does-stresschaos-disappear" class="table-of-contents__link toc-highlight">Why does StressChaos disappear?</a></li><li><a href="#what-if-there-was-no-liveness-probe" class="table-of-contents__link toc-highlight">What if there was no liveness probe?</a></li><li><a href="#deeper-dive-into-kubernetes-memory-management" class="table-of-contents__link toc-highlight">Deeper dive into Kubernetes memory management</a></li><li><a href="#how-we-implement-stresschaos" class="table-of-contents__link toc-highlight">How we implement StressChaos</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/quick-start/">快速试用（测试推荐）</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/run-a-chaos-experiment/">运行实验</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/developer-guide-overview/">开发指南概览</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/faqs/">FAQs</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://community.cncf.io/chaos-mesh-community/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_OmM5"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack (#project-chaos-mesh)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_OmM5"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/chaos_mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_OmM5"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/blog/">博客</a></li><li class="footer__item"><a href="https://github.com/chaos-mesh/chaos-mesh" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_OmM5"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Thanks</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.netlify.com"><img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify"></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>© Chaos Mesh Authors 2021 | Documentation Distributed under CC-BY-4.0 </strong>
        <br>
        <br>
        © 2021 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.
      </div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.2b51fdf5.js"></script>
<script src="/zh/assets/js/main.af6f94e2.js"></script>
</body>
</html>